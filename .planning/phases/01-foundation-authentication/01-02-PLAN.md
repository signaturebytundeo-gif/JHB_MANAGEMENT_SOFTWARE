---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/session.ts
  - src/lib/dal.ts
  - src/lib/validators/auth.ts
  - src/lib/auth/permissions.ts
  - src/proxy.ts
  - src/app/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/layout.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/app/actions/auth.ts
  - src/components/auth/LoginForm.tsx
  - src/components/layout/Sidebar.tsx
  - src/components/layout/Header.tsx
  - src/components/theme-provider.tsx
  - src/components/toaster.tsx
autonomous: true

must_haves:
  truths:
    - "User can log in with email and password and be redirected to role-appropriate dashboard"
    - "Invalid credentials show error message without revealing which field is wrong"
    - "Unauthenticated users are redirected to /login when accessing protected routes"
    - "Authenticated users are redirected away from /login to their dashboard"
    - "Dark mode toggle switches between light and dark themes without flash on reload"
    - "Toast notifications appear on login success and login failure"
    - "Dashboard layout has a responsive sidebar that collapses on mobile"
  artifacts:
    - path: "src/lib/session.ts"
      provides: "JWT session management with encrypt/decrypt/createSession/deleteSession"
      exports: ["encrypt", "decrypt", "createSession", "deleteSession"]
    - path: "src/lib/dal.ts"
      provides: "Data Access Layer with session verification and role checks"
      exports: ["verifySession", "verifyAdmin", "verifyManagerOrAbove", "getUser"]
    - path: "src/proxy.ts"
      provides: "Route protection proxy for Next.js 16+"
      contains: "protectedRoutes"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with email/password form"
      contains: "LoginForm"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Authenticated dashboard layout with sidebar and header"
      contains: "Sidebar"
    - path: "src/app/actions/auth.ts"
      provides: "Server Actions for login and logout"
      exports: ["login", "logout"]
    - path: "src/components/auth/LoginForm.tsx"
      provides: "Client component login form with validation"
      contains: "useActionState"
    - path: "src/lib/validators/auth.ts"
      provides: "Zod schemas for auth validation"
      exports: ["loginSchema"]
    - path: "src/lib/auth/permissions.ts"
      provides: "Role permission matrix and helper functions"
      exports: ["getRoleDashboard", "ROLE_PERMISSIONS"]
  key_links:
    - from: "src/app/actions/auth.ts"
      to: "src/lib/session.ts"
      via: "Server Action creates session after successful login"
      pattern: "createSession"
    - from: "src/app/actions/auth.ts"
      to: "src/lib/db.ts"
      via: "Server Action queries User table for authentication"
      pattern: "db\\.user\\.findUnique"
    - from: "src/proxy.ts"
      to: "src/lib/session.ts"
      via: "Proxy decrypts session cookie to check authentication"
      pattern: "decrypt"
    - from: "src/lib/dal.ts"
      to: "src/lib/session.ts"
      via: "DAL verifies session for data access authorization"
      pattern: "decrypt"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/dal.ts"
      via: "Layout verifies session before rendering dashboard"
      pattern: "verifySession|getUser"
    - from: "src/components/auth/LoginForm.tsx"
      to: "src/app/actions/auth.ts"
      via: "Form submits to login Server Action"
      pattern: "useActionState.*login"
---

<objective>
Implement the complete authentication flow: JWT session management, login with email/password, route protection via proxy, Data Access Layer for authorization, and the dashboard layout shell with responsive sidebar, dark mode, and toast notifications.

Purpose: This is the core authentication infrastructure that every protected feature depends on. Without working login, session management, and route protection, no other module can function.
Output: Working login flow, protected dashboard with sidebar, dark mode toggle, toast notifications.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement session management, DAL, proxy, and auth Server Actions</name>
  <files>
    src/lib/session.ts
    src/lib/dal.ts
    src/lib/validators/auth.ts
    src/lib/auth/permissions.ts
    src/app/actions/auth.ts
    src/proxy.ts
  </files>
  <action>
    1. Create `src/lib/session.ts` — Stateless JWT session management:
       - Mark with `import 'server-only'` at top
       - Use `jose` library (NOT jsonwebtoken — CommonJS issues with Edge runtime)
       - `SESSION_SECRET` from `process.env.SESSION_SECRET`
       - `encrypt(payload: SessionPayload): Promise<string>` — SignJWT with HS256, setIssuedAt, setExpirationTime('7d')
       - `decrypt(session: string | undefined): Promise<SessionPayload | undefined>` — jwtVerify with try/catch, return undefined on failure
       - `createSession(userId: string, role: string): Promise<void>` — encrypt payload {userId, role, expiresAt}, set httpOnly cookie named 'session' with secure (only in production), sameSite 'lax', path '/'
       - `deleteSession(): Promise<void>` — delete the 'session' cookie
       - `updateSession(): Promise<void>` — sliding expiration: read cookie, decrypt, re-encrypt with new 7-day expiry, set cookie
       - SessionPayload type: { userId: string, role: string, expiresAt: Date }

    2. Create `src/lib/dal.ts` — Data Access Layer:
       - Mark with `import 'server-only'` at top
       - `verifySession()` — cached with React `cache()`. Read session cookie, decrypt, redirect to /login if no valid session. Return { isAuth: true, userId, role }
       - `verifyAdmin()` — calls verifySession(), throws if role !== 'ADMIN'
       - `verifyManagerOrAbove()` — calls verifySession(), throws if role not in ['ADMIN', 'MANAGER']
       - `getUser()` — cached. Calls verifySession(), queries db.user.findUnique by userId. Select: id, name, email, role, isActive. Returns user or null.

    3. Create `src/lib/validators/auth.ts` — Zod schemas:
       - `loginSchema`: email (string, email, trim, lowercase), password (string, min 1 "Password is required")
       - `LoginFormState` type: { errors?: { email?: string[], password?: string[] }, message?: string } | undefined

    4. Create `src/lib/auth/permissions.ts` — Role permissions:
       - `getRoleDashboard(role: string): string` — maps ADMIN->'/dashboard', MANAGER->'/dashboard', SALES_REP->'/dashboard', INVESTOR->'/dashboard/investor'
       - `ROLE_PERMISSIONS` constant object mapping each role to allowed sections:
         - ADMIN: ['dashboard', 'production', 'inventory', 'orders', 'customers', 'finance', 'reports', 'settings', 'investor']
         - MANAGER: ['dashboard', 'production', 'inventory', 'orders', 'customers', 'reports']
         - SALES_REP: ['dashboard', 'orders', 'customers']
         - INVESTOR: ['investor']
       - `hasPermission(role: string, section: string): boolean` helper function

    5. Create `src/app/actions/auth.ts` — Server Actions:
       - `'use server'` directive
       - `login(prevState: LoginFormState, formData: FormData)`:
         1. Validate with loginSchema.safeParse
         2. If invalid, return { errors: validatedFields.error.flatten().fieldErrors }
         3. Query db.user.findUnique by email
         4. If no user, return { message: 'Invalid email or password' } (generic message — never reveal which field)
         5. Compare password with bcrypt.compare (cost factor already in hash)
         6. If mismatch, return { message: 'Invalid email or password' }
         7. If user.isActive is false, return { message: 'Account is deactivated' }
         8. Call createSession(user.id, user.role)
         9. redirect to getRoleDashboard(user.role)
       - `logout()`:
         1. Call deleteSession()
         2. redirect to '/login'

    6. Create `src/proxy.ts` — Route protection (proxy.ts for Next.js 16+):
       - Define protectedRoutes = ['/dashboard']
       - Define publicRoutes = ['/login', '/register', '/invite']
       - Check if path starts with any protected route
       - If protected and no valid session: redirect to /login
       - If public auth route and has valid session: redirect to getRoleDashboard
       - If session exists and not expired: call updateSession() for sliding expiration
       - Export config.matcher to exclude static assets, api routes, _next: `['/((?!api|_next/static|_next/image|.*\\.png$).*)']`
       - NOTE: Import decrypt from session.ts, but do NOT import redirect from next/navigation in proxy (use NextResponse.redirect)
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    ```
    TypeScript compiles without errors. All imports resolve correctly.
  </verify>
  <done>
    - `src/lib/session.ts` exports encrypt, decrypt, createSession, deleteSession, updateSession
    - `src/lib/dal.ts` exports verifySession, verifyAdmin, verifyManagerOrAbove, getUser — all cached
    - `src/lib/validators/auth.ts` exports loginSchema with email and password validation
    - `src/lib/auth/permissions.ts` exports getRoleDashboard, ROLE_PERMISSIONS, hasPermission
    - `src/app/actions/auth.ts` exports login and logout Server Actions
    - `src/proxy.ts` protects /dashboard routes and redirects authenticated users from /login
    - Password comparison uses bcrypt.compare (never plain text)
    - Login error messages are generic (never reveal if email exists)
    - Session cookie is httpOnly, sameSite lax, 7-day expiry with sliding renewal
  </done>
</task>

<task type="auto">
  <name>Task 2: Build login page, dashboard layout with sidebar, dark mode, and toast notifications</name>
  <files>
    src/app/layout.tsx
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
    src/components/auth/LoginForm.tsx
    src/components/layout/Sidebar.tsx
    src/components/layout/Header.tsx
    src/components/theme-provider.tsx
    src/components/toaster.tsx
  </files>
  <action>
    1. Create `src/components/theme-provider.tsx` — ThemeProvider wrapper:
       - 'use client' directive
       - Wrap next-themes ThemeProvider
       - Export ThemeProvider component

    2. Create `src/components/toaster.tsx` — Sonner toast wrapper:
       - 'use client' directive
       - Import Toaster from sonner
       - Position: "top-right"
       - Style toasts with Caribbean theme: action button bg-caribbean-green, dark mode support

    3. Update `src/app/layout.tsx` — Root layout:
       - Add `suppressHydrationWarning` to `<html>` tag
       - Wrap children in ThemeProvider with attribute="class", defaultTheme="system", enableSystem, disableTransitionOnChange
       - Add Toaster component
       - Set metadata: title "JHB Command Center", description

    4. Create `src/app/(auth)/layout.tsx` — Auth layout (no sidebar):
       - Simple centered layout with Caribbean branding
       - Full-screen with gradient background using caribbean-green and caribbean-black
       - Company name "JHB Command Center" prominently displayed
       - Mobile-first: works on phone screens

    5. Create `src/components/auth/LoginForm.tsx` — Login form component:
       - 'use client' directive
       - Use `useActionState` hook (React 19) with the login Server Action
       - Form fields: email (type="email"), password (type="password")
       - Use shadcn/ui Button, Input, Label, Card components
       - Show validation errors below fields
       - Show general error message (from server) at top
       - Show loading state on submit button (disable + spinner text)
       - Use `toast` from sonner on error for additional feedback
       - Mobile-first: full-width card on mobile, max-w-md on desktop
       - Caribbean styling: green primary button, gold accent on focus

    6. Create `src/app/(auth)/login/page.tsx` — Login page:
       - Import LoginForm component
       - Simple page that renders LoginForm within auth layout
       - Page title: "Sign In"

    7. Create `src/components/layout/Sidebar.tsx` — Dashboard sidebar:
       - 'use client' directive (needs state for collapse/expand)
       - Props: user ({ name, email, role }), currentPath
       - Navigation items based on role (use hasPermission from permissions.ts):
         - Dashboard (icon: Home) — all roles
         - Production (icon: Factory) — admin, manager
         - Inventory (icon: Package) — admin, manager
         - Orders (icon: ShoppingCart) — admin, manager, sales
         - Customers (icon: Users) — admin, manager, sales
         - Finance (icon: DollarSign) — admin
         - Reports (icon: BarChart) — admin, manager
         - Settings (icon: Settings) — admin
         - Investor Portal (icon: TrendingUp) — admin, investor
       - Use Lucide React icons (installed with shadcn)
       - Mobile: hidden by default, shown via hamburger menu (sheet/drawer overlay)
       - Desktop: fixed left sidebar, 64px wide collapsed, 256px expanded
       - Collapsed state shows icons only, expanded shows icons + labels
       - Caribbean styling: dark sidebar (caribbean-black), active item highlighted with caribbean-green, gold accent on hover
       - Logout button at bottom of sidebar
       - User avatar/initials at top with name and role badge

    8. Create `src/components/layout/Header.tsx` — Dashboard header:
       - Props: user, onMenuToggle (for mobile sidebar)
       - Mobile: hamburger menu button (left), page title (center)
       - Desktop: page title (left), user info + dark mode toggle (right)
       - Dark mode toggle: use `useTheme` from next-themes, Sun/Moon icon button
       - Caribbean styling: subtle border-bottom with caribbean-gold

    9. Create `src/app/(dashboard)/layout.tsx` — Dashboard layout:
       - Server Component that calls getUser() from DAL
       - If no user, redirect to /login
       - Render Sidebar + Header + main content area
       - Mobile-first: full-width content, sidebar as overlay
       - Desktop: sidebar fixed left, content offset by sidebar width

    10. Create `src/app/(dashboard)/page.tsx` — Default dashboard page:
        - Server Component that calls getUser() from DAL
        - Show welcome message: "Welcome back, {user.name}"
        - Show role badge
        - Placeholder KPI cards with loading skeleton pattern (Suspense + skeleton)
        - Cards: "Coming soon" placeholders for Today's Revenue, Units Produced, Open Orders, etc.
        - Mobile-first: single column on mobile, 2 cols on md, 3 cols on lg
        - Use Caribbean color palette for card accents
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build completes without errors. Then manually verify:
    1. Visit http://localhost:3000 — should redirect to /login
    2. Enter invalid credentials — should show error toast and inline error
    3. Enter Anthony's credentials (anthony@jamaicahousebrand.com / JHB2026!) — should redirect to /dashboard
    4. Dashboard shows sidebar with role-appropriate navigation
    5. Dark mode toggle works without flash on reload
    6. Sidebar collapses/expands on desktop, shows as overlay on mobile
    7. Clicking logout returns to /login
  </verify>
  <done>
    - Login page renders with Caribbean-branded auth layout
    - Email/password form validates with Zod and shows field-level errors
    - Invalid credentials show generic "Invalid email or password" error
    - Successful login creates JWT session and redirects to /dashboard
    - Dashboard layout has responsive sidebar (overlay on mobile, fixed on desktop)
    - Sidebar shows role-appropriate navigation items
    - Header has dark mode toggle that works without hydration flash
    - Toast notifications appear on login errors
    - Logout clears session and redirects to /login
    - Protected routes redirect to /login when unauthenticated
    - /login redirects to /dashboard when already authenticated
    - All views are mobile-first responsive
  </done>
</task>

</tasks>

<verification>
1. Unauthenticated access to /dashboard redirects to /login
2. Login with anthony@jamaicahousebrand.com / JHB2026! succeeds and redirects to /dashboard
3. Login with wrong password shows "Invalid email or password" error
4. Dashboard sidebar shows all navigation items for Admin role
5. Dark mode toggle switches theme without page flash
6. Toast notification appears on login failure
7. Logout clears session and returns to /login
8. Accessing /login while authenticated redirects to /dashboard
9. Mobile view shows hamburger menu instead of sidebar
</verification>

<success_criteria>
1. Complete login-to-dashboard flow works end-to-end
2. JWT sessions stored in httpOnly cookies with 7-day sliding expiration
3. Route protection via proxy.ts blocks unauthenticated access
4. DAL provides cached session verification for Server Components
5. Responsive sidebar navigation with role-based item filtering
6. Dark mode works without hydration flash
7. Toast notifications functional via Sonner
8. All UI is mobile-first responsive
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
