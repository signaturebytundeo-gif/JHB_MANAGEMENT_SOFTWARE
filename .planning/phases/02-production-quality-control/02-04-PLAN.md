---
phase: 02-production-quality-control
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/dashboard/settings/co-packers/page.tsx
  - src/components/settings/CoPackerPartnerForm.tsx
  - src/app/actions/settings.ts
  - src/app/(dashboard)/dashboard/production/raw-materials/page.tsx
  - src/components/production/RawMaterialForm.tsx
  - src/components/production/RawMaterialList.tsx
autonomous: true

must_haves:
  truths:
    - "User can add and edit co-packer partners in settings without code changes"
    - "User can deactivate co-packer partners (soft delete, not hard delete)"
    - "User can track raw materials with lot numbers, suppliers, and expiration dates"
    - "Co-packer partner list in settings is accessible to Admin users"
    - "Raw materials page shows material inventory with expiration awareness"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/settings/co-packers/page.tsx"
      provides: "Co-packer partner management page in settings"
      min_lines: 20
    - path: "src/components/settings/CoPackerPartnerForm.tsx"
      provides: "Add/edit co-packer partner form"
      min_lines: 40
    - path: "src/app/actions/settings.ts"
      provides: "Server Actions for co-packer partner CRUD"
      exports: ["createCoPackerPartner", "updateCoPackerPartner", "toggleCoPackerPartner"]
    - path: "src/app/(dashboard)/dashboard/production/raw-materials/page.tsx"
      provides: "Raw materials management page"
      min_lines: 20
    - path: "src/components/production/RawMaterialForm.tsx"
      provides: "Add raw material form"
      min_lines: 40
    - path: "src/components/production/RawMaterialList.tsx"
      provides: "Raw materials list with expiration indicators"
      min_lines: 40
  key_links:
    - from: "src/components/settings/CoPackerPartnerForm.tsx"
      to: "src/app/actions/settings.ts"
      via: "useActionState with createCoPackerPartner"
      pattern: "useActionState.*createCoPackerPartner"
    - from: "src/components/production/RawMaterialForm.tsx"
      to: "src/app/actions/production.ts"
      via: "useActionState with createRawMaterial"
      pattern: "useActionState.*createRawMaterial"
---

<objective>
Build co-packer partner management in settings and raw materials tracking in production. These are supporting features that enable the core batch creation workflow.

Purpose: Co-packer partner list must be configurable without code changes (PROD-10). Raw materials need lot number and supplier tracking for traceability (PROD-09). Both are required for regulatory compliance.
Output: Settings page for co-packer partners at /dashboard/settings/co-packers, raw materials page at /dashboard/production/raw-materials.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-quality-control/02-01-SUMMARY.md
@src/app/actions/auth.ts
@src/lib/dal.ts
@src/lib/db.ts
@src/lib/validators/production.ts
@src/app/(dashboard)/dashboard/settings/page.tsx
@src/app/(dashboard)/dashboard/settings/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create co-packer partner management in settings</name>
  <files>src/app/actions/settings.ts, src/components/settings/CoPackerPartnerForm.tsx, src/app/(dashboard)/dashboard/settings/co-packers/page.tsx</files>
  <action>
**File 1: `src/app/actions/settings.ts`**

Create Server Actions for co-packer partner CRUD. Follow the auth.ts pattern:
- 'use server' directive
- Import db, validators (coPackerPartnerSchema from production validators), dal (verifyAdmin)

1. `createCoPackerPartner(prevState: CoPackerPartnerFormState, formData: FormData): Promise<CoPackerPartnerFormState>`
   - `verifyAdmin()` — only admins manage settings
   - Validate with coPackerPartnerSchema
   - Check for duplicate name (case-insensitive)
   - Create CoPackerPartner record
   - `revalidatePath('/dashboard/settings/co-packers')`
   - Return `{ success: true, message: 'Partner added successfully' }`

2. `updateCoPackerPartner(prevState: CoPackerPartnerFormState, formData: FormData): Promise<CoPackerPartnerFormState>`
   - `verifyAdmin()`
   - Extract partnerId from formData
   - Validate with coPackerPartnerSchema
   - Update record
   - `revalidatePath('/dashboard/settings/co-packers')`
   - Return `{ success: true, message: 'Partner updated' }`

3. `toggleCoPackerPartner(partnerId: string): Promise<{ success: boolean; message: string }>`
   - `verifyAdmin()`
   - Find partner, toggle isActive
   - `revalidatePath('/dashboard/settings/co-packers')`
   - Return result

**File 2: `src/components/settings/CoPackerPartnerForm.tsx`** (client component)

Create an add/edit form for co-packer partners:
- 'use client' directive
- Props: `partner?: { id, name, contactName, email, phone, address }` (optional, for edit mode)
- Use `useActionState` with createCoPackerPartner or updateCoPackerPartner
- Fields: Name (required), Contact Name, Email, Phone, Address
- All fields use text-base and h-11 for mobile
- If editing, pre-populate fields and include hidden partnerId input
- Submit button: "Add Partner" or "Update Partner"
- Show success/error messages

**File 3: `src/app/(dashboard)/dashboard/settings/co-packers/page.tsx`** (server component)

Create the co-packer settings page:
- `verifyAdmin()` at top (only admins access settings)
- Fetch all partners: `db.coPackerPartner.findMany({ orderBy: { name: 'asc' } })`
- Page layout:
  - Header: "Co-Packer Partners" with breadcrumb "Settings > Co-Packer Partners"
  - CoPackerPartnerForm for adding new partner
  - List of existing partners in a Table:
    - Columns: Name, Contact, Email, Phone, Status (Active/Inactive badge)
    - Each row has: Edit button (toggles inline edit or opens form), Activate/Deactivate button
    - Deactivated partners shown with muted styling
  - For simplicity, use the form at top for adding. For editing, either:
    (a) Use inline editing in the table rows, OR
    (b) Use a simple "edit" link that shows the form pre-populated
    Choose option (b) — clicking Edit renders the CoPackerPartnerForm with partner data instead of the add form (use client-side state to toggle between add/edit mode, or use URL search params)
  - Deactivation uses a form with hidden partnerId that calls toggleCoPackerPartner via a button

Also add a link to this page from the existing settings page (`src/app/(dashboard)/dashboard/settings/page.tsx`). Read the existing settings page first and add a Card link: "Co-Packer Partners — Manage co-packing partner list" linking to /dashboard/settings/co-packers.
  </action>
  <verify>
1. Navigate to /dashboard/settings — see "Co-Packer Partners" link card
2. Navigate to /dashboard/settings/co-packers — see existing partners (Space Coast Sauces, Tabanero Holdings from seed)
3. Add a new partner — form submits, partner appears in list
4. Deactivate a partner — status changes to Inactive, styling is muted
5. Reactivate a partner — status returns to Active
6. Only Admin users can access (Manager/Sales should get redirected or error)
7. `npx tsc --noEmit` passes
  </verify>
  <done>
Co-packer partners are manageable from /dashboard/settings/co-packers without code changes. Partners can be added, edited, and activated/deactivated. Only Admin users have access. Settings page has link to co-packer management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create raw materials tracking page</name>
  <files>src/components/production/RawMaterialForm.tsx, src/components/production/RawMaterialList.tsx, src/app/(dashboard)/dashboard/production/raw-materials/page.tsx, src/app/actions/production.ts</files>
  <action>
**IMPORTANT: `src/app/actions/production.ts` may have been created by Plan 02-02. If it exists, ADD the new functions to it. If Plan 02-02 hasn't run yet (parallel execution), create the file with just these functions and a note that createBatch/submitQCTest/etc. will be added by Plan 02-02. However, since Plan 02-02 owns this file, the safer approach is:**

Create a separate actions file: `src/app/actions/raw-materials.ts` to avoid file conflicts.

**File 1: `src/app/actions/raw-materials.ts`**

- 'use server' directive
- Import db, rawMaterialSchema from validators, verifyManagerOrAbove from dal

1. `createRawMaterial(prevState: RawMaterialFormState, formData: FormData): Promise<RawMaterialFormState>`
   - `verifyManagerOrAbove()`
   - Validate with rawMaterialSchema
   - Create RawMaterial record
   - `revalidatePath('/dashboard/production/raw-materials')`
   - Return `{ success: true, message: 'Raw material added' }`

2. `getRawMaterials()` — async function
   - Fetch all raw materials where isActive: true
   - Order by expirationDate asc (soonest expiring first)
   - Return typed array

3. `deactivateRawMaterial(id: string): Promise<{ success: boolean; message: string }>`
   - `verifyManagerOrAbove()`
   - Soft delete: set isActive to false
   - `revalidatePath('/dashboard/production/raw-materials')`

**File 2: `src/components/production/RawMaterialForm.tsx`** (client component)

Create raw material entry form:
- 'use client' directive
- Use `useActionState(createRawMaterial, undefined)`
- Fields:
  - Name (text input, required)
  - Supplier (text input, required)
  - Lot Number (text input, required)
  - Received Date (date input, required)
  - Expiration Date (date input, required)
  - Quantity (number input with inputMode="decimal", required)
  - Unit (Select: "kg", "lbs", "liters", "gallons", "units", "cases")
- Submit button: "Add Raw Material"
- Mobile-optimized: text-base, h-11 touch targets
- Show success/error messages

**File 3: `src/components/production/RawMaterialList.tsx`** (server-compatible component)

Create raw materials list:
- Props: `materials: RawMaterial[]`
- Table with columns: Name, Supplier, Lot #, Qty + Unit, Received, Expires, Status
- Expiration status logic:
  - Expired (past date): red badge "Expired"
  - Expiring soon (within 30 days): yellow badge "Expiring Soon"
  - OK (> 30 days): green badge "OK"
- Use date-fns `differenceInDays` and `format` for date calculations
- Each row has a "Remove" button (soft delete via form action calling deactivateRawMaterial)
- Mobile: On small screens, use card layout instead of table (same responsive pattern as BatchList)
- Empty state: "No raw materials tracked yet"

**File 4: `src/app/(dashboard)/dashboard/production/raw-materials/page.tsx`** (server component)

Create the raw materials page:
- `verifySession()` at top
- Fetch raw materials using getRawMaterials() or direct db query
- Page layout:
  - Header: "Raw Materials" with back link "< Back to Production" to /dashboard/production
  - RawMaterialForm at top for adding new materials
  - Divider
  - RawMaterialList showing existing materials
- Add a link/button to this page from the production list page. Since the production page (page.tsx) is owned by Plan 03, add the link as a secondary navigation item. Actually, since we can't modify files owned by Plan 03, add a sub-navigation approach:
  - The page is accessible at /dashboard/production/raw-materials
  - Plan 03's production page can link here (or it can be discovered via URL)
  - For now, just make the page functional at its route
  </action>
  <verify>
1. Navigate to /dashboard/production/raw-materials — page renders
2. Add a raw material with all fields — material appears in list
3. Expiration badges show correct status (Expired/Expiring Soon/OK)
4. Remove a raw material — it disappears from list (soft deleted)
5. Navigate to /dashboard/settings/co-packers — partner management works
6. `npx tsc --noEmit` passes
  </verify>
  <done>
Raw materials page at /dashboard/production/raw-materials shows material inventory with expiration tracking. Materials can be added and soft-deleted. Expiration badges provide visual alerts. Co-packer partner settings page is fully functional with CRUD operations.
  </done>
</task>

</tasks>

<verification>
1. /dashboard/settings has a link to co-packer partner management
2. /dashboard/settings/co-packers lists seeded partners and supports add/edit/toggle
3. /dashboard/production/raw-materials shows raw material tracking with expiration awareness
4. New raw materials can be added with lot numbers and supplier information
5. Co-packer partner list is used in batch creation form (via database query in Plan 02)
6. Only appropriate roles can access each page (Admin for settings, Manager+ for raw materials)
7. All deactivations are soft deletes (isActive flag)
</verification>

<success_criteria>
- Co-packer partners are configurable from settings UI without code changes (PROD-10)
- Raw materials track lot numbers, suppliers, and expiration dates (PROD-09)
- Expiration dates have visual indicators (expired, expiring soon, OK)
- All deletions are soft deletes for data integrity
- Role-based access control is enforced
- All TypeScript files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-quality-control/02-04-SUMMARY.md`
</output>
