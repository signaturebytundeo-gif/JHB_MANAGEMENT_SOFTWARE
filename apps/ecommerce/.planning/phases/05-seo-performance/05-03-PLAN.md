---
phase: 05-seo-performance
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/layout.tsx
  - src/components/analytics/GoogleAnalytics.tsx
  - src/components/analytics/MetaPixel.tsx
  - src/components/analytics/TrackPurchase.tsx
  - src/app/success/page.tsx
  - package.json
autonomous: false
user_setup:
  - service: google-analytics
    why: "Track page views and user behavior across all pages"
    env_vars:
      - name: NEXT_PUBLIC_GA_MEASUREMENT_ID
        source: "Google Analytics -> Admin -> Data Streams -> Measurement ID (starts with G-)"
    dashboard_config:
      - task: "Create GA4 property for jamaicahousebrand.com"
        location: "https://analytics.google.com -> Admin -> Create Property"
  - service: meta-pixel
    why: "Track page views and purchase conversions for Facebook/Instagram ads"
    env_vars:
      - name: NEXT_PUBLIC_META_PIXEL_ID
        source: "Meta Events Manager -> Data Sources -> Pixel ID"
    dashboard_config:
      - task: "Create Meta Pixel for jamaicahousebrand.com"
        location: "https://business.facebook.com -> Events Manager -> Connect Data Sources -> Web -> Meta Pixel"

must_haves:
  truths:
    - "Google Analytics 4 loads on every page and tracks page views automatically"
    - "Meta Pixel loads on every page and tracks page views"
    - "Meta Pixel fires Purchase event on order success page with order value"
    - "Analytics scripts only load when env vars are configured (graceful fallback when missing)"
    - "Analytics do not block page rendering (loaded after content)"
  artifacts:
    - path: "src/components/analytics/GoogleAnalytics.tsx"
      provides: "GA4 component using @next/third-parties"
      contains: "GoogleAnalytics"
    - path: "src/components/analytics/MetaPixel.tsx"
      provides: "Meta Pixel client component with page view tracking"
      contains: "use client"
    - path: "src/components/analytics/TrackPurchase.tsx"
      provides: "Purchase event tracker with deduplication"
      contains: "Purchase"
    - path: "src/app/layout.tsx"
      provides: "Root layout with analytics components"
      contains: "GoogleAnalytics"
    - path: "src/app/success/page.tsx"
      provides: "Success page with Meta Pixel Purchase event"
      contains: "TrackPurchase"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/components/analytics/GoogleAnalytics.tsx"
      via: "renders GA4 component after body content"
      pattern: "GoogleAnalytics"
    - from: "src/app/layout.tsx"
      to: "src/components/analytics/MetaPixel.tsx"
      via: "renders Meta Pixel component in Suspense boundary"
      pattern: "MetaPixel"
    - from: "src/app/success/page.tsx"
      to: "src/components/analytics/TrackPurchase.tsx"
      via: "renders TrackPurchase with session total"
      pattern: "TrackPurchase"
---

<objective>
Integrate Google Analytics 4 and Meta Pixel tracking across all pages. GA4 tracks page views automatically via @next/third-parties. Meta Pixel tracks page views on navigation and fires Purchase events on the order success page.

Purpose: TECH-08 requires GA4 on all pages. TECH-09 requires Meta Pixel for page views and purchase events. These are essential for measuring marketing ROI and understanding user behavior. Without analytics, there is no way to measure the effectiveness of the site or ad campaigns.

Output: GA4 component, Meta Pixel component, TrackPurchase component, updated layout with analytics, purchase tracking on success page
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-seo-performance/05-RESEARCH.md
@.planning/phases/05-seo-performance/05-01-SUMMARY.md

@/Users/rfmstaff/Desktop/jamaica-house-brand/src/app/layout.tsx
@/Users/rfmstaff/Desktop/jamaica-house-brand/src/app/success/page.tsx
@/Users/rfmstaff/Desktop/jamaica-house-brand/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Dependencies and Create Analytics Components</name>
  <files>
    package.json
    src/components/analytics/GoogleAnalytics.tsx
    src/components/analytics/MetaPixel.tsx
    src/components/analytics/TrackPurchase.tsx
  </files>
  <action>
**Install @next/third-parties:**
Run `cd /Users/rfmstaff/Desktop/jamaica-house-brand && npm install @next/third-parties`

Do NOT install react-facebook-pixel (it has CommonJS issues and is unmaintained). Instead, implement Meta Pixel with inline script approach for better control and no extra dependency.

**Create src/components/analytics/GoogleAnalytics.tsx:**

This is a thin wrapper that conditionally renders the @next/third-parties GoogleAnalytics component:

```tsx
import { GoogleAnalytics as NextGoogleAnalytics } from '@next/third-parties/google'

export default function GoogleAnalytics() {
  const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID
  if (!gaId) return null
  return <NextGoogleAnalytics gaId={gaId} />
}
```

This is a Server Component (no 'use client' needed). @next/third-parties handles script optimization and automatic App Router page view tracking.

**Create src/components/analytics/MetaPixel.tsx:**

This is a Client Component that:
1. Loads the Meta Pixel script via useEffect on mount
2. Fires fbq('track', 'PageView') on initial load
3. Fires fbq('track', 'PageView') on route changes using usePathname

```tsx
'use client'

import { useEffect } from 'react'
import { usePathname, useSearchParams } from 'next/navigation'

declare global {
  interface Window {
    fbq: (...args: unknown[]) => void
    _fbq: (...args: unknown[]) => void
  }
}

export default function MetaPixel() {
  const pathname = usePathname()
  const searchParams = useSearchParams()
  const pixelId = process.env.NEXT_PUBLIC_META_PIXEL_ID

  useEffect(() => {
    if (!pixelId) return
    if (typeof window.fbq === 'function') return // Already initialized

    // Standard Meta Pixel initialization snippet
    const f: any = window
    const b = document
    const e = 'script'
    const v = 'https://connect.facebook.net/en_US/fbevents.js'

    if (f.fbq) return
    const n: any = f.fbq = function() {
      n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments)
    }
    if (!f._fbq) f._fbq = n
    n.push = n
    n.loaded = true
    n.version = '2.0'
    n.queue = []
    const t = b.createElement(e) as HTMLScriptElement
    t.async = true
    t.src = v
    const s = b.getElementsByTagName(e)[0]
    s?.parentNode?.insertBefore(t, s)

    window.fbq('init', pixelId)
    window.fbq('track', 'PageView')
  }, [pixelId])

  // Track page views on route changes
  useEffect(() => {
    if (!pixelId || typeof window.fbq !== 'function') return
    window.fbq('track', 'PageView')
  }, [pathname, searchParams, pixelId])

  if (!pixelId) return null

  // noscript fallback for users with JS disabled
  return (
    <noscript>
      <img
        height="1"
        width="1"
        style={{ display: 'none' }}
        src={`https://www.facebook.com/tr?id=${pixelId}&ev=PageView&noscript=1`}
        alt=""
      />
    </noscript>
  )
}
```

IMPORTANT: MetaPixel uses useSearchParams which requires a Suspense boundary when rendered.

**Create src/components/analytics/TrackPurchase.tsx:**

Client Component that fires the Meta Pixel Purchase event exactly once:

```tsx
'use client'

import { useEffect, useRef } from 'react'

export default function TrackPurchase({
  value,
  currency = 'USD',
  orderId,
}: {
  value: number
  currency?: string
  orderId?: string
}) {
  const tracked = useRef(false)

  useEffect(() => {
    if (tracked.current) return
    tracked.current = true

    if (typeof window !== 'undefined' && typeof window.fbq === 'function') {
      window.fbq('track', 'Purchase', {
        value: value / 100, // Convert cents to dollars
        currency,
        ...(orderId && { content_ids: [orderId] }),
      })
    }
  }, [value, currency, orderId])

  return null
}
```

The `tracked` ref prevents duplicate Purchase events if the user refreshes the success page (addresses Pitfall 7 from research).
  </action>
  <verify>
Run `cd /Users/rfmstaff/Desktop/jamaica-house-brand && npx next build` and confirm no build errors. Verify @next/third-parties is in package.json dependencies. Verify all three analytics components exist in src/components/analytics/.
  </verify>
  <done>
@next/third-parties installed. GoogleAnalytics.tsx conditionally renders GA4 when env var exists. MetaPixel.tsx initializes pixel script and tracks page views on route changes. TrackPurchase.tsx fires Purchase event exactly once with ref guard. All gracefully do nothing when env vars are missing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Analytics into Layout and Add Purchase Tracking to Success Page</name>
  <files>
    src/app/layout.tsx
    src/app/success/page.tsx
  </files>
  <action>
**Update src/app/layout.tsx:**

Read the current file first (it was updated in Plan 01 with metadataBase). Add analytics components:

1. Import GoogleAnalytics from '@/components/analytics/GoogleAnalytics'
2. Import MetaPixel from '@/components/analytics/MetaPixel'
3. Import { Suspense } from 'react'
4. Add `<GoogleAnalytics />` after the closing `</body>` tag but before `</html>` (this is the recommended placement per @next/third-parties docs — it renders the gtag script)
5. Add `<Suspense fallback={null}><MetaPixel /></Suspense>` inside the body, after `<CartDrawer />` — the Suspense boundary is required because MetaPixel uses useSearchParams

The layout JSX should look like:
```tsx
<html lang="en" className={`${plusJakarta.variable} dark`}>
  <body className="bg-brand-dark text-white antialiased">
    <div className="flex flex-col min-h-screen">
      <Navigation />
      <main className="flex-1">
        {children}
      </main>
      <Footer />
    </div>
    <CartDrawer />
    <Suspense fallback={null}>
      <MetaPixel />
    </Suspense>
  </body>
  <GoogleAnalytics />
</html>
```

Do NOT change the metadata export — that was already configured in Plan 01.

**Update src/app/success/page.tsx:**

1. Import TrackPurchase from '@/components/analytics/TrackPurchase'
2. In the successful payment section (after `<ClearCartOnSuccess />`), add:
   ```tsx
   <TrackPurchase value={session.amount_total ?? 0} orderId={session.id} />
   ```
3. Only render TrackPurchase in the success case (when session.status === 'complete'), not in error/pending states.
  </action>
  <verify>
Run `cd /Users/rfmstaff/Desktop/jamaica-house-brand && npx next build` and confirm no build errors. Verify:
1. layout.tsx imports and renders GoogleAnalytics and MetaPixel
2. MetaPixel is wrapped in Suspense
3. GoogleAnalytics is between body and html closing tags
4. success/page.tsx renders TrackPurchase with session amount
  </verify>
  <done>
GA4 loads on every page via @next/third-parties (auto-tracks page views). Meta Pixel loads on every page and tracks page views on route changes. Purchase events fire once on order success page with order value in dollars. All analytics gracefully skip when env vars are not configured.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Complete SEO and Analytics Implementation</name>
  <files>n/a</files>
  <action>
Human verification checkpoint for the complete Phase 5 SEO and analytics infrastructure across all 3 plans:
- Root metadata with metadataBase, title template, keywords, robots config
- Dynamic sitemap.xml and robots.txt generation
- Product JSON-LD schema on all product detail pages
- XSS-sanitized Recipe JSON-LD on all recipe detail pages
- Next.js image optimization (WebP/AVIF, quality whitelist)
- Google Analytics 4 via @next/third-parties
- Meta Pixel with page view and purchase event tracking
  </action>
  <verify>
1. Start dev server: `cd /Users/rfmstaff/Desktop/jamaica-house-brand && npm run dev`
2. Visit http://localhost:3000/sitemap.xml — should show XML listing home, shop, our-story, recipes, all 4 product URLs, and all 6 recipe URLs
3. Visit http://localhost:3000/robots.txt — should show allow all, disallow /api/ and /success, with sitemap reference
4. Visit http://localhost:3000/products/jerk-sauce-5oz — View Page Source, search for "application/ld+json" — should find Product schema with price "7.99" and brand "Jamaica House Brand"
5. Visit http://localhost:3000/recipes/authentic-jerk-chicken — View Page Source, search for "application/ld+json" — should find Recipe schema (verify no raw less-than characters in JSON-LD)
6. Check the browser tab title — should follow "Page Title | Jamaica House Brand" pattern
7. View Page Source on homepage — verify meta description, keywords, og:site_name present
8. Confirm site still works: navigation, cart, product pages all functional
9. Note: GA4 and Meta Pixel will not send data until env vars are configured with real IDs (this is expected and correct)
  </verify>
  <done>
User has verified: sitemap.xml lists all pages, robots.txt is correct, Product JSON-LD renders on product pages, Recipe JSON-LD is sanitized, title template works, meta tags are present, analytics components render without errors, and site is fully functional.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. /sitemap.xml accessible with all page URLs
3. /robots.txt accessible with correct rules
4. Product pages have Product JSON-LD with correct schema
5. Recipe pages have sanitized Recipe JSON-LD
6. GA4 component renders when NEXT_PUBLIC_GA_MEASUREMENT_ID is set
7. Meta Pixel tracks page views and purchase events
8. All analytics skip gracefully when env vars are missing
9. No visual regressions on any page
</verification>

<success_criteria>
- All TECH-01 through TECH-09 requirements addressed
- Build succeeds with zero errors
- Sitemap lists 14+ URLs
- Product JSON-LD has correct price (dollars, not cents), availability, brand
- Recipe JSON-LD is XSS-sanitized
- Analytics load without blocking page render
- Purchase events fire exactly once per success page visit
- Site remains fully functional with no visual regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-seo-performance/05-03-SUMMARY.md`
</output>
