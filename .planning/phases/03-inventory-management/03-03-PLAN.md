---
phase: 03-inventory-management
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/app/(dashboard)/dashboard/inventory/transfers/page.tsx
  - src/app/(dashboard)/dashboard/inventory/adjustments/page.tsx
  - src/components/inventory/TransferForm.tsx
  - src/components/inventory/AdjustmentForm.tsx
  - src/components/inventory/AuditTrailTable.tsx
  - src/components/inventory/PendingApprovals.tsx
  - src/app/(dashboard)/dashboard/inventory/audit-trail/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can transfer inventory between locations and the transfer deducts from source, adds to destination using FIFO batch allocation"
    - "User can make inventory adjustments with reason codes (damage, shrinkage, sampling, expired, count correction)"
    - "Adjustments exceeding 2% variance require approval from a different admin before affecting stock levels"
    - "All inventory movements create immutable audit trail entries visible in the audit trail page"
    - "Transfers preserve FIFO by maintaining original batch associations at destination"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/inventory/transfers/page.tsx"
      provides: "Transfer page with form and recent transfer history"
      min_lines: 20
    - path: "src/app/(dashboard)/dashboard/inventory/adjustments/page.tsx"
      provides: "Adjustment page with form, pending approvals list, and recent adjustment history"
      min_lines: 20
    - path: "src/components/inventory/TransferForm.tsx"
      provides: "Transfer form with product, source/dest location, quantity inputs"
      min_lines: 40
    - path: "src/components/inventory/AdjustmentForm.tsx"
      provides: "Adjustment form with batch, location, quantity change, reason code inputs"
      min_lines: 40
    - path: "src/components/inventory/AuditTrailTable.tsx"
      provides: "Filterable table of all inventory movements"
      min_lines: 40
    - path: "src/components/inventory/PendingApprovals.tsx"
      provides: "List of adjustments awaiting admin approval with approve/reject actions"
      min_lines: 30
    - path: "src/app/(dashboard)/dashboard/inventory/audit-trail/page.tsx"
      provides: "Audit trail page showing all inventory movements with filters"
      min_lines: 20
  key_links:
    - from: "src/components/inventory/TransferForm.tsx"
      to: "src/app/actions/inventory.ts"
      via: "useActionState with transferInventory server action"
      pattern: "useActionState.*transferInventory"
    - from: "src/components/inventory/AdjustmentForm.tsx"
      to: "src/app/actions/inventory.ts"
      via: "useActionState with createAdjustment server action"
      pattern: "useActionState.*createAdjustment"
    - from: "src/components/inventory/PendingApprovals.tsx"
      to: "src/app/actions/inventory.ts"
      via: "Calls approveAdjustment server action"
      pattern: "approveAdjustment"
---

<objective>
Build the inventory transfer, adjustment, and audit trail UI pages with approval workflow.

Purpose: This plan delivers the write-side of inventory management — users can move inventory between locations (transfers), correct discrepancies (adjustments with reason codes), and view the complete movement history (audit trail). The dual approval workflow for large adjustments (>2% variance) ensures accountability. These are core operational features that Anthony and Tunde will use daily.

Output: Transfer page with FIFO-aware form, adjustment page with reason codes and pending approvals, and full audit trail page.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-inventory-management/03-RESEARCH.md
@.planning/phases/03-inventory-management/03-01-SUMMARY.md
@.planning/phases/03-inventory-management/03-02-SUMMARY.md

Key patterns from Plan 02:
- Server actions in src/app/actions/inventory.ts: transferInventory, createAdjustment, approveAdjustment, getAuditTrail, getProductsForTransfer, getLocationsForTransfer
- Form state type: TransferFormState, AdjustmentFormState from validators/inventory.ts
- useActionState pattern from Phase 2 batch creation forms
- Mobile-first: text-base inputs, h-11 touch targets, inputMode="numeric"
- Responsive: table on desktop, cards on mobile

Existing UI components available:
- Button, Input, Label from src/components/ui/
- Badge from src/components/ui/badge.tsx (success/warning/destructive)
- Textarea from src/components/ui/textarea.tsx
- Select pattern: native HTML select with Tailwind styling (from batch creation form)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build TransferForm, AdjustmentForm, and PendingApprovals components</name>
  <files>src/components/inventory/TransferForm.tsx, src/components/inventory/AdjustmentForm.tsx, src/components/inventory/PendingApprovals.tsx</files>
  <action>
**src/components/inventory/TransferForm.tsx:**

'use client' component using useActionState with transferInventory server action.

Form fields:
1. Product (select dropdown) — populated from products prop. Show product name + SKU + size.
2. From Location (select dropdown) — populated from locations prop. Show location name.
3. To Location (select dropdown) — same locations list. Add .refine validation that from !== to (server-side handles this, but also disable the currently-selected from location in the to dropdown for UX).
4. Quantity (number input) — positive integer, inputMode="numeric", min="1"
5. Notes (textarea, optional) — reason for transfer

Submit button: "Transfer Inventory" / "Transferring..." when pending.

Success/error message display below form (green for success, red for error).

After successful transfer, show a brief summary: "Transferred X units of [Product] from [Location A] to [Location B]".

Props: `{ products: Array<{id, name, sku, size}>, locations: Array<{id, name}> }`

Mobile-first: All inputs text-base (16px), touch targets h-11, full-width on mobile, two-column grid on desktop for from/to locations.

**src/components/inventory/AdjustmentForm.tsx:**

'use client' component using useActionState with createAdjustment server action.

Form fields:
1. Batch (select dropdown) — populated from batches prop. Show batchCode + product name + location. Only show RELEASED batches.
2. Location (select dropdown) — populated from locations prop. When batch is selected, ideally filter to locations where that batch has allocations. If too complex, show all locations.
3. Quantity Change (number input) — can be positive (found extra) or negative (lost units). inputMode="numeric". Label: "Quantity Change (positive = add, negative = remove)"
4. Reason (select dropdown) — DAMAGE, SHRINKAGE, SAMPLING, EXPIRED, COUNT_CORRECTION
5. Notes (textarea, optional)

Submit button: "Submit Adjustment" / "Submitting..." when pending.

Show different messages based on response:
- Auto-approved: green "Adjustment applied" message
- Requires approval: yellow "Adjustment submitted for approval (>2% variance)" message
- Error: red error message

Props: `{ batches: Array<{id, batchCode, productName}>, locations: Array<{id, name}> }`

**src/components/inventory/PendingApprovals.tsx:**

'use client' component showing pending adjustments awaiting approval.

For each pending adjustment, show:
- Batch code and product name
- Location
- Quantity change (with +/- sign)
- Reason code
- Notes (if any)
- Submitted by (user name)
- Submitted at (formatted date)
- Variance percentage
- Approve button (calls approveAdjustment server action)

Only show this component to ADMIN users. Pass `isAdmin` prop.

If the current user is the creator, disable the approve button with tooltip "Cannot approve your own adjustment".

Use responsive card layout. Each pending approval as a card with action button.

Props: `{ pendingMovements: Array<movement with batch, location, createdBy details>, currentUserId: string, isAdmin: boolean }`
  </action>
  <verify>
1. `npx tsc --noEmit` — all three components compile
2. TransferForm uses useActionState with transferInventory
3. AdjustmentForm uses useActionState with createAdjustment
4. PendingApprovals calls approveAdjustment on approve click
  </verify>
  <done>
TransferForm renders product/location/quantity fields with useActionState, AdjustmentForm renders batch/location/quantity/reason fields with approval status feedback, PendingApprovals shows pending adjustments with approve buttons (disabled for own adjustments). All mobile-first with touch-friendly inputs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build transfer page, adjustment page, audit trail page with AuditTrailTable</name>
  <files>src/app/(dashboard)/dashboard/inventory/transfers/page.tsx, src/app/(dashboard)/dashboard/inventory/adjustments/page.tsx, src/components/inventory/AuditTrailTable.tsx, src/app/(dashboard)/dashboard/inventory/audit-trail/page.tsx</files>
  <action>
**src/app/(dashboard)/dashboard/inventory/transfers/page.tsx:**

Server Component:
1. verifyManagerOrAbove() for access control
2. Fetch products via getProductsForTransfer() and locations via getLocationsForTransfer()
3. Fetch recent transfers via getAuditTrail({ movementType: 'TRANSFER' }) for transfer history
4. Render page header: "Inventory Transfers" with breadcrumb back to /dashboard/inventory
5. Render TransferForm with products and locations props
6. Below form, show "Recent Transfers" section with a simple table/list of recent transfer movements
   - Each row: date, product (via batch), from location, to location, quantity, transferred by
   - Use responsive table-to-cards pattern

**src/app/(dashboard)/dashboard/inventory/adjustments/page.tsx:**

Server Component:
1. verifyManagerOrAbove() for access control
2. Fetch batches (RELEASED only, with product name), locations, pending approvals, and recent adjustments
3. Get current session to determine if user is ADMIN (for approval permissions)
4. Render page header: "Inventory Adjustments"
5. If user is ADMIN and pending approvals exist, render PendingApprovals component at the top with yellow background section ("X adjustments awaiting your approval")
6. Render AdjustmentForm
7. Below form, show "Recent Adjustments" section — similar to transfers but showing reason code and approval status (Approved / Pending Approval / Auto-Approved)

**src/components/inventory/AuditTrailTable.tsx:**

'use client' component for the full audit trail with filtering.

Table columns:
- Date/Time (formatted with date-fns)
- Type (PRODUCTION, TRANSFER, ADJUSTMENT, etc.) with colored badge
- Product (via batch relation)
- Batch Code
- From Location (or "—" if null)
- To Location (or "—" if null)
- Quantity (with +/- context based on movement type)
- Reason (for adjustments, otherwise "—")
- Status (Approved / Pending / Auto-Approved)
- Created By (user name)

Filters (client-side since data set is small, matching Phase 2 pattern):
- Movement type filter (dropdown: All, Production, Transfer, Adjustment)
- Product filter (dropdown)
- Location filter (dropdown)

Mobile: Card layout with key info (date, type, product, quantity, status).

Props: `{ movements: Array<movement with all relations> }`

**src/app/(dashboard)/dashboard/inventory/audit-trail/page.tsx:**

Server Component:
1. verifySession() (all authenticated users can view audit trail)
2. Fetch all movements via getAuditTrail() (no filters, returns latest 100)
3. Render page header: "Audit Trail" with breadcrumb to /dashboard/inventory
4. Render AuditTrailTable with movements data
  </action>
  <verify>
1. `npx tsc --noEmit` — all files compile
2. /dashboard/inventory/transfers renders form with product/location dropdowns
3. /dashboard/inventory/adjustments renders form with batch/reason dropdowns and pending approvals (if any)
4. /dashboard/inventory/audit-trail renders filterable movement table
5. All pages have breadcrumb navigation back to /dashboard/inventory
  </verify>
  <done>
Transfer page shows FIFO-aware transfer form with recent transfer history. Adjustment page shows reason code form with pending approvals for admins and recent adjustment history. Audit trail page shows all inventory movements with client-side filters by type, product, and location. All pages are mobile-responsive with card layouts on small screens.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /dashboard/inventory/transfers renders with product and location dropdowns
3. /dashboard/inventory/adjustments renders with batch and reason dropdowns
4. PendingApprovals section visible to ADMIN users when pending adjustments exist
5. /dashboard/inventory/audit-trail shows all movements with filters
6. TransferForm connects to transferInventory server action via useActionState
7. AdjustmentForm connects to createAdjustment server action via useActionState
8. All pages link back to /dashboard/inventory
</verification>

<success_criteria>
- INV-03: Transfers use FIFO allocation (oldest batches first) and preserve batch association at destination
- INV-04: Transfer form submits and creates paired outbound/inbound InventoryMovement records
- INV-05: Adjustment form requires reason code from predefined list
- INV-06: Adjustments >2% variance show "pending approval" message and require admin approval
- INV-09: Audit trail page shows every inventory movement with timestamp, user, reason, and approval status
- All forms follow mobile-first pattern with 16px inputs and 44px touch targets
</success_criteria>

<output>
After completion, create `.planning/phases/03-inventory-management/03-03-SUMMARY.md`
</output>
