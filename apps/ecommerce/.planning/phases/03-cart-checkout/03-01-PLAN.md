---
phase: 03-cart-checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/cart-store.ts
  - src/components/CartDrawer.tsx
  - src/components/CartItem.tsx
  - src/components/ui/QuickAddButton.tsx
  - src/components/navigation/Navigation.tsx
  - src/app/products/[slug]/page.tsx
  - src/app/layout.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can add items to cart from shop grid Quick Add buttons"
    - "User can add items to cart from product detail page with selected quantity"
    - "Cart drawer slides in from right side without page redirect"
    - "Cart shows item image, name, quantity, price, and subtotal"
    - "User can update quantity or remove items from cart drawer"
    - "Cart state persists across page refresh and navigation"
    - "Cart icon in navigation shows item count badge"
  artifacts:
    - path: "src/lib/cart-store.ts"
      provides: "Zustand cart store with persist middleware"
      contains: "persist"
    - path: "src/components/CartDrawer.tsx"
      provides: "Slide-over cart drawer with Headless UI Dialog"
      contains: "Dialog"
    - path: "src/components/CartItem.tsx"
      provides: "Cart item row with quantity controls and remove"
      contains: "updateQuantity"
  key_links:
    - from: "src/components/ui/QuickAddButton.tsx"
      to: "src/lib/cart-store.ts"
      via: "useCartStore addItem action"
      pattern: "useCartStore.*addItem"
    - from: "src/components/CartDrawer.tsx"
      to: "src/lib/cart-store.ts"
      via: "useCartStore items selector"
      pattern: "useCartStore.*items"
    - from: "src/app/layout.tsx"
      to: "src/components/CartDrawer.tsx"
      via: "CartDrawer rendered in root layout"
      pattern: "CartDrawer"
---

<objective>
Implement the shopping cart: Zustand state store with localStorage persistence, accessible slide-over cart drawer with Headless UI Dialog, and wire all existing add-to-cart touchpoints (QuickAddButton, product detail page, navigation cart link).

Purpose: Enable users to build an order by adding products from any page, viewing their cart contents in a slide-over drawer, and adjusting quantities — the foundation for checkout.
Output: Working cart with add/update/remove functionality, persistent state, and accessible drawer UI.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cart-checkout/03-RESEARCH.md

Key existing files to understand before modifying:
@src/types/product.ts
@src/data/products.ts
@src/lib/utils.ts (formatPrice, calculateSubtotal already exist)
@src/components/ui/QuickAddButton.tsx (currently logs to console — wire to cart store)
@src/components/navigation/Navigation.tsx (Cart link currently goes to /cart — change to open drawer)
@src/app/products/[slug]/page.tsx (Add to Cart button is static placeholder — wire to cart store)
@src/components/product/QuantitySelector.tsx (has onChange callback — use to track quantity for add to cart)
@src/app/layout.tsx (need to add CartDrawer here)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Zustand cart store with localStorage persistence</name>
  <files>
    package.json
    src/lib/cart-store.ts
  </files>
  <action>
    1. Install required packages:
       ```bash
       npm install stripe zustand @headlessui/react
       ```

    2. Create `src/lib/cart-store.ts` — the Zustand cart store with persist middleware:
       - Define `CartItem` interface: `{ id: string, name: string, price: number, quantity: number, image: string, size: string }`
       - Include `size` in CartItem because the same product (Original Jerk Sauce) comes in multiple sizes — size differentiates them in the cart display
       - Define `CartStore` interface with:
         - `items: CartItem[]`
         - `isOpen: boolean` (controls drawer visibility — co-located in cart store for simplicity)
         - `addItem(item: Omit<CartItem, 'quantity'>, quantity?: number)` — if item exists, increment quantity; otherwise add with quantity (default 1)
         - `updateQuantity(id: string, quantity: number)` — if quantity <= 0, remove item
         - `removeItem(id: string)`
         - `clearCart()`
         - `openCart()`
         - `closeCart()`
         - `totalItems` computed getter (sum of all item quantities)
       - Use `persist` middleware with `name: 'jamaica-house-cart'` and `skipHydration: true` to avoid SSR hydration mismatch
       - Only persist `items` (not `isOpen`) using the `partialize` option: `partialize: (state) => ({ items: state.items })`
       - Prices are already in cents (from product data) — pass through unchanged. Do NOT multiply by 100.
  </action>
  <verify>
    Run `npm ls zustand @headlessui/react stripe` to confirm packages installed.
    Run `npx tsc --noEmit` to confirm no TypeScript errors in cart-store.ts.
  </verify>
  <done>
    Zustand cart store exists with addItem, updateQuantity, removeItem, clearCart, openCart, closeCart actions. Persist middleware configured with skipHydration. All 3 packages installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CartDrawer and CartItem components, wire all add-to-cart touchpoints</name>
  <files>
    src/components/CartItem.tsx
    src/components/CartDrawer.tsx
    src/components/ui/QuickAddButton.tsx
    src/components/navigation/Navigation.tsx
    src/app/products/[slug]/page.tsx
    src/app/layout.tsx
  </files>
  <action>
    **CartItem.tsx** — Client Component (`'use client'`):
    - Props: `{ item: CartItem }` (import CartItem type from cart-store)
    - Display: product image (w-20 h-20 rounded object-cover), name, size, unit price (use `formatPrice` from `@/lib/utils`)
    - Quantity controls: minus button, quantity number, plus button — same style as existing QuantitySelector (w-8 h-8 bg-white/5 border border-brand-gold/30 rounded)
    - Minus button calls `updateQuantity(item.id, item.quantity - 1)` (store auto-removes at 0)
    - Plus button calls `updateQuantity(item.id, item.quantity + 1)`
    - Remove button (text "Remove" or X icon) calls `removeItem(item.id)`, text-gray-400 hover:text-white
    - Line total: display `formatPrice(item.price * item.quantity)` aligned right
    - Minimum 44px touch targets on all buttons (w-11 h-11 or equivalent) per WCAG decision
    - Use aria-label on quantity buttons ("Decrease quantity", "Increase quantity") and remove button ("Remove {item.name} from cart")

    **CartDrawer.tsx** — Client Component (`'use client'`):
    - Import `Dialog, DialogPanel, DialogTitle, Transition, TransitionChild` from `@headlessui/react` and `Fragment` from `react`
    - Import `useCartStore` from `@/lib/cart-store`
    - Import `formatPrice` from `@/lib/utils`
    - On mount (useEffect with empty deps), call `useCartStore.persist.rehydrate()` to hydrate from localStorage after SSR
    - Read `isOpen` and `closeCart` from store to control Dialog open/close
    - Read `items` from store
    - Calculate subtotal: `items.reduce((sum, item) => sum + item.price * item.quantity, 0)`
    - Transition: slide in from right (translate-x-full → translate-x-0), backdrop fade (opacity-0 → opacity-100)
    - Use duration-300 ease-in-out for enter, duration-200 ease-in for leave
    - Dialog panel: `max-w-md w-screen`, dark background `bg-brand-dark`, full height
    - Header: DialogTitle "Your Cart" with close button (X icon, w-11 h-11 touch target)
    - Body: scrollable list of CartItem components. If empty, show "Your cart is empty" message with a "Continue Shopping" link to /shop
    - Footer (sticky bottom): subtotal line (`formatPrice(subtotal)`), "Checkout" button (w-full bg-brand-gold text-brand-dark font-bold py-4 rounded-lg). Checkout button is a placeholder for now (just logs "checkout" — Plan 03-02 will wire it to Stripe).
    - Checkout button disabled when cart is empty

    **QuickAddButton.tsx** — Update existing:
    - Import `useCartStore` from `@/lib/cart-store`
    - Add `productPrice`, `productImage`, `productSize` to props interface
    - In handleClick: call `useCartStore.getState().addItem({ id: productId, name: productName, price: productPrice, image: productImage, size: productSize })` then `useCartStore.getState().openCart()` to show the drawer
    - Using `getState()` instead of hook selector for event handlers is fine and avoids re-renders

    **ProductCard.tsx** — Update QuickAddButton usage:
    - Pass additional props to QuickAddButton: `productPrice={product.price}`, `productImage={product.image}`, `productSize={product.size}`
    - NOTE: ProductCard.tsx is a Server Component that renders QuickAddButton as a Client Component leaf — this pattern is already established

    **Navigation.tsx** — Update Cart link:
    - Import `useCartStore` from `@/lib/cart-store`
    - Replace the Cart `<Link href="/cart">` with a `<button>` that calls `useCartStore.getState().openCart()`
    - Add a cart count badge: read items from store, compute total count, show as a small gold circle (w-5 h-5 bg-brand-gold text-brand-dark text-xs font-bold rounded-full) positioned next to "Cart" text. Only show badge when count > 0.
    - Keep 44px touch target on the cart button
    - In mobile menu, also replace Cart link with button that opens drawer and closes mobile menu

    **Product Detail Page (app/products/[slug]/page.tsx)** — Wire Add to Cart:
    - The page is a Server Component, so create a new Client Component wrapper: `src/components/product/AddToCartSection.tsx`
    - `AddToCartSection` props: `{ product: Product }`
    - Internally renders QuantitySelector (tracks local quantity state) and the Add to Cart button
    - On Add to Cart click: calls `useCartStore.getState().addItem({ id: product.id, name: product.name, price: product.price, image: product.image, size: product.size }, quantity)` then `useCartStore.getState().openCart()`
    - Replace the inline QuantitySelector + button in page.tsx with `<AddToCartSection product={product} />`

    **Layout (app/layout.tsx)** — Add CartDrawer:
    - Import CartDrawer
    - Add `<CartDrawer />` after `<Footer />` but inside the body (it renders its own portal via Dialog). Place it as a sibling of the flex container, not inside it.

    **Important implementation notes:**
    - All brand colors use semantic Tailwind classes (bg-brand-dark, bg-brand-gold, text-brand-gold) — do NOT use arbitrary values like bg-[#1A1A1A]
    - The dark theme is already set — match existing aesthetic
    - Do NOT use `Fragment` shorthand `<>` with Transition — use `Fragment` import from react (Headless UI requirement)
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    Run `npm run build` — build succeeds with no errors.
    Verify files exist: `ls src/components/CartDrawer.tsx src/components/CartItem.tsx src/components/product/AddToCartSection.tsx`
  </verify>
  <done>
    CartDrawer slides in from right with accessible Dialog. CartItem shows image/name/size/price with quantity controls. QuickAddButton adds to cart and opens drawer. Navigation shows cart count badge and opens drawer on click. Product detail page Add to Cart button adds selected quantity to cart and opens drawer. Cart state persists across page refresh via localStorage. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npx tsc --noEmit` passes with zero errors
3. All 3 new packages in node_modules: `npm ls zustand @headlessui/react stripe`
4. Cart store file exists with persist middleware: `grep -l "persist" src/lib/cart-store.ts`
5. CartDrawer uses Headless UI Dialog: `grep -l "Dialog" src/components/CartDrawer.tsx`
6. QuickAddButton wired to cart: `grep -l "useCartStore\|addItem" src/components/ui/QuickAddButton.tsx`
7. Navigation has cart count badge: `grep -l "totalItems\|items.reduce\|badge\|count" src/components/navigation/Navigation.tsx`
8. Layout includes CartDrawer: `grep -l "CartDrawer" src/app/layout.tsx`
</verification>

<success_criteria>
- Cart store with add/update/remove/clear actions exists and compiles
- CartDrawer renders as accessible slide-over with item list, quantities, and subtotal
- QuickAddButton (shop grid) adds product to cart and opens drawer
- Product detail page Add to Cart adds selected quantity and opens drawer
- Navigation Cart link opens drawer and shows item count badge
- Cart persists in localStorage across page refresh
- All existing pages still render correctly (no regressions)
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-cart-checkout/03-01-SUMMARY.md`
</output>
