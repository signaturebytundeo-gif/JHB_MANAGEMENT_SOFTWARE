---
phase: 05-seo-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/seo.ts
  - src/app/products/[slug]/page.tsx
  - src/app/recipes/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Product detail pages render a JSON-LD script tag with Product schema containing name (with size), image, price in dollars, availability URL, and brand"
    - "Recipe detail pages sanitize JSON-LD output to prevent XSS (< replaced with \\u003c)"
    - "Product schema prices are formatted as dollars (e.g. '3.99') not cents (e.g. '399')"
  artifacts:
    - path: "src/lib/seo.ts"
      provides: "generateProductJsonLd and sanitizeJsonLd alongside existing generateRecipeJsonLd"
      contains: "generateProductJsonLd"
    - path: "src/app/products/[slug]/page.tsx"
      provides: "Product page with JSON-LD structured data injection"
      contains: "application/ld+json"
  key_links:
    - from: "src/app/products/[slug]/page.tsx"
      to: "src/lib/seo.ts"
      via: "imports generateProductJsonLd and sanitizeJsonLd"
      pattern: "generateProductJsonLd"
    - from: "src/app/recipes/[slug]/page.tsx"
      to: "src/lib/seo.ts"
      via: "imports sanitizeJsonLd for XSS protection"
      pattern: "sanitizeJsonLd"
---

<objective>
Add Product JSON-LD structured data to product detail pages and fix XSS vulnerability in existing Recipe JSON-LD.

Purpose: Product schema is required for Google Shopping rich results (price, availability, reviews). The existing Recipe JSON-LD uses raw JSON.stringify in dangerouslySetInnerHTML without sanitizing < characters, which is an XSS vulnerability. Both issues are addressed in this plan.

Output: generateProductJsonLd function in seo.ts, JSON-LD injection in product pages, sanitized JSON-LD in recipe pages
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-seo-performance/05-RESEARCH.md

@/Users/rfmstaff/Desktop/jamaica-house-brand/src/lib/seo.ts
@/Users/rfmstaff/Desktop/jamaica-house-brand/src/app/products/[slug]/page.tsx
@/Users/rfmstaff/Desktop/jamaica-house-brand/src/app/recipes/[slug]/page.tsx
@/Users/rfmstaff/Desktop/jamaica-house-brand/src/types/product.ts
@/Users/rfmstaff/Desktop/jamaica-house-brand/src/data/products.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generateProductJsonLd and sanitizeJsonLd to seo.ts</name>
  <files>
    src/lib/seo.ts
  </files>
  <action>
Add two new exports to `src/lib/seo.ts` while keeping the existing `generateRecipeJsonLd` function completely unchanged.

1. Add a `sanitizeJsonLd` helper function:
   ```typescript
   export function sanitizeJsonLd(obj: Record<string, unknown>): string {
     return JSON.stringify(obj).replace(/</g, '\\u003c')
   }
   ```
   This prevents XSS when using dangerouslySetInnerHTML with JSON-LD. Both product and recipe pages should use this.

2. Define a `ProductJsonLdInput` interface:
   ```typescript
   interface ProductJsonLdInput {
     name: string
     description: string
     image: string
     price: number       // in cents (matches Product type)
     size: string
     slug: string
     inStock: boolean
     rating: number
   }
   ```

3. Add `generateProductJsonLd` function:
   ```typescript
   export function generateProductJsonLd(input: ProductJsonLdInput) {
     const jsonLd: Record<string, unknown> = {
       '@context': 'https://schema.org',
       '@type': 'Product',
       name: `${input.name} - ${input.size}`,
       description: input.description,
       image: `https://jamaicahousebrand.com${input.image}`,
       brand: {
         '@type': 'Brand',
         name: 'Jamaica House Brand',
       },
       offers: {
         '@type': 'Offer',
         price: (input.price / 100).toFixed(2),
         priceCurrency: 'USD',
         availability: input.inStock
           ? 'https://schema.org/InStock'
           : 'https://schema.org/OutOfStock',
         url: `https://jamaicahousebrand.com/products/${input.slug}`,
         seller: {
           '@type': 'Organization',
           name: 'Jamaica House Brand',
         },
       },
     }

     if (input.rating) {
       jsonLd.aggregateRating = {
         '@type': 'AggregateRating',
         ratingValue: input.rating.toString(),
         bestRating: '5',
         worstRating: '1',
       }
     }

     return jsonLd
   }
   ```

   Key decisions:
   - Price is converted from cents to dollars (product.price is stored as cents per Product type)
   - Image URL is made absolute with the site domain
   - Uses plain objects instead of schema-dts to avoid adding a dependency for just 2 JSON-LD generators
   - Follows the same manual typing pattern as the existing generateRecipeJsonLd
  </action>
  <verify>
Verify that seo.ts compiles: `cd /Users/rfmstaff/Desktop/jamaica-house-brand && npx tsc --noEmit src/lib/seo.ts` (or run full build). Confirm the file exports generateRecipeJsonLd, generateProductJsonLd, and sanitizeJsonLd.
  </verify>
  <done>
seo.ts exports three functions: generateRecipeJsonLd (unchanged), generateProductJsonLd (new), and sanitizeJsonLd (new). Product JSON-LD includes name with size, absolute image URL, price in dollars, availability URL, brand, seller, and optional aggregateRating.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject Product JSON-LD in product pages and fix Recipe JSON-LD sanitization</name>
  <files>
    src/app/products/[slug]/page.tsx
    src/app/recipes/[slug]/page.tsx
  </files>
  <action>
1. **Update `src/app/products/[slug]/page.tsx`:**
   - Add import: `import { generateProductJsonLd, sanitizeJsonLd } from '@/lib/seo'`
   - In the `ProductDetailPage` component, after the `if (!product) notFound()` check, generate JSON-LD:
     ```typescript
     const productJsonLd = generateProductJsonLd({
       name: product.name,
       description: product.description,
       image: product.image,
       price: product.price,
       size: product.size,
       slug: product.slug,
       inStock: product.inStock,
       rating: product.rating,
     })
     ```
   - Wrap the return JSX in a fragment and add the JSON-LD script tag before the existing div:
     ```tsx
     return (
       <>
         <script
           type="application/ld+json"
           dangerouslySetInnerHTML={{ __html: sanitizeJsonLd(productJsonLd) }}
         />
         <div className="pt-8 sm:pt-12 pb-16 sm:pb-24 px-4">
           {/* ... existing content unchanged ... */}
         </div>
       </>
     )
     ```

2. **Update `src/app/recipes/[slug]/page.tsx`:**
   - Add `sanitizeJsonLd` to the existing import from `@/lib/seo`:
     ```typescript
     import { generateRecipeJsonLd, sanitizeJsonLd } from '@/lib/seo'
     ```
   - Change the existing JSON-LD script tag from:
     ```tsx
     dangerouslySetInnerHTML={{ __html: JSON.stringify(recipeJsonLd) }}
     ```
     to:
     ```tsx
     dangerouslySetInnerHTML={{ __html: sanitizeJsonLd(recipeJsonLd as unknown as Record<string, unknown>) }}
     ```
     Note: The cast is needed because RecipeJsonLd is a specific interface, not Record<string, unknown>. Alternatively, update sanitizeJsonLd to accept `object` instead of `Record<string, unknown>` — use whichever approach avoids type errors cleanly. The simplest approach is to make sanitizeJsonLd accept `unknown` and cast internally: `export function sanitizeJsonLd(obj: unknown): string { return JSON.stringify(obj).replace(/</g, '\\u003c') }`
  </action>
  <verify>
Run `cd /Users/rfmstaff/Desktop/jamaica-house-brand && npx next build` — build succeeds. Verify:
1. `grep -r 'application/ld+json' src/app/products/` returns a match
2. `grep -r 'sanitizeJsonLd' src/app/recipes/` returns a match
3. `grep -r 'sanitizeJsonLd' src/app/products/` returns a match
  </verify>
  <done>
Product detail pages render Product schema JSON-LD with name+size, absolute image URL, price in dollars, availability, brand, seller, and rating. Recipe detail pages use sanitized JSON-LD output. Both pages are protected against XSS via the sanitizeJsonLd helper.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. Product pages include JSON-LD script with @type: Product
3. Recipe pages use sanitizeJsonLd (not raw JSON.stringify)
4. seo.ts exports generateRecipeJsonLd, generateProductJsonLd, sanitizeJsonLd
5. Product price is in dollars format (e.g., "3.99")
</verification>

<success_criteria>
- All 4 product detail pages render valid Product schema JSON-LD
- All 6 recipe detail pages render XSS-sanitized Recipe schema JSON-LD
- Product JSON-LD includes name with size, absolute image, price in dollars, availability, brand
- generateProductJsonLd converts cents to dollars correctly
- No new dependencies added (schema-dts skipped in favor of manual types)
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-seo-performance/05-02-SUMMARY.md`
</output>
