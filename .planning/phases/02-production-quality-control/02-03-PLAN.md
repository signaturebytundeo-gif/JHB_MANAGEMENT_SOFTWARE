---
phase: 02-production-quality-control
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/dashboard/production/page.tsx
  - src/app/(dashboard)/dashboard/production/[id]/page.tsx
  - src/components/production/BatchList.tsx
  - src/components/production/BatchStatusBadge.tsx
  - src/components/production/QCTestingForm.tsx
  - src/components/production/CapacityMetrics.tsx
autonomous: true

must_haves:
  truths:
    - "User can view batch list filtered by date range, product, source, and status"
    - "User can see batch status with color-coded badges for all 5 states"
    - "User can enter pH reading and pass/fail QC check on batch detail page"
    - "Batches that fail QC show HOLD status and are visually distinct (red/warning)"
    - "User can view production capacity utilization vs 15,000 unit/month target"
    - "Batch records show all details including QC history, allocations, and co-packer info"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/production/page.tsx"
      provides: "Production list page replacing placeholder"
      min_lines: 30
    - path: "src/app/(dashboard)/dashboard/production/[id]/page.tsx"
      provides: "Batch detail page with QC testing"
      min_lines: 50
    - path: "src/components/production/BatchList.tsx"
      provides: "Filterable batch table component"
      min_lines: 60
    - path: "src/components/production/BatchStatusBadge.tsx"
      provides: "Color-coded status badge using CVA"
      exports: ["BatchStatusBadge"]
    - path: "src/components/production/QCTestingForm.tsx"
      provides: "QC test entry form (pH and visual/taste)"
      min_lines: 50
    - path: "src/components/production/CapacityMetrics.tsx"
      provides: "Capacity utilization display vs 15K target"
      min_lines: 30
  key_links:
    - from: "src/components/production/BatchList.tsx"
      to: "src/app/(dashboard)/dashboard/production/[id]/page.tsx"
      via: "Link to batch detail"
      pattern: "href.*production.*id"
    - from: "src/components/production/QCTestingForm.tsx"
      to: "src/app/actions/production.ts"
      via: "useActionState with submitQCTest"
      pattern: "useActionState.*submitQCTest"
    - from: "src/app/(dashboard)/dashboard/production/page.tsx"
      to: "src/app/actions/production.ts"
      via: "getBatches and getProductionMetrics data fetching"
      pattern: "getBatches|getProductionMetrics"
---

<objective>
Build the batch list page (replacing the placeholder), batch detail page with QC testing forms, status badges, and capacity utilization metrics.

Purpose: Users need to view, filter, and inspect their production batches, perform QC tests, and track capacity. This is the read/QC side of production tracking -- complementary to Plan 02's creation flow.
Output: Working production list at /dashboard/production, batch detail at /dashboard/production/[id], capacity metrics widget.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-quality-control/02-01-SUMMARY.md
@src/app/actions/production.ts
@src/lib/dal.ts
@src/lib/db.ts
@src/components/ui/table.tsx
@src/components/ui/select.tsx
@src/components/ui/input.tsx
@src/components/ui/card.tsx
@src/components/dashboard/KPICard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchStatusBadge, BatchList, and production list page</name>
  <files>src/components/production/BatchStatusBadge.tsx, src/components/production/BatchList.tsx, src/components/production/CapacityMetrics.tsx, src/app/(dashboard)/dashboard/production/page.tsx</files>
  <action>
**File 1: `src/components/production/BatchStatusBadge.tsx`**

Create a status badge component using class-variance-authority (CVA) pattern:
- Import `cva` from 'class-variance-authority' and `cn` from '@/lib/utils'
- Define variants for all 5 BatchStatus values:
  - PLANNED: bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300
  - IN_PROGRESS: bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
  - QC_REVIEW: bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300
  - RELEASED: bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
  - HOLD: bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
- Props: `status: string`, optional `className`
- Render as inline-flex span with rounded-full, px-2.5, py-0.5, text-xs, font-medium
- Display human-readable label: PLANNED -> "Planned", IN_PROGRESS -> "In Progress", QC_REVIEW -> "QC Review", RELEASED -> "Released", HOLD -> "Hold"

**File 2: `src/components/production/CapacityMetrics.tsx`** (server-compatible, no 'use client')

Create a capacity utilization display:
- Props: `totalUnits: number`, `target: number` (default 15000), `batchCount: number`, `utilizationPercent: number`
- Render using the Card component from shadcn/ui
- Show: "Production Capacity" title, "{totalUnits} / {target} units" as main metric
- Visual progress bar: div with bg-muted background, inner div with bg-caribbean-green width based on percentage (capped at 100%)
- Show percentage text and batch count below
- Color coding: green < 70%, yellow 70-90%, red > 90%
- Use existing KPICard pattern for visual consistency

**File 3: `src/components/production/BatchList.tsx`** (client component for filter interactivity)

Create a filterable batch list table:
- 'use client' directive
- Props: `initialBatches: BatchWithRelations[]` (typed with batch + product + coPackerPartner + createdBy + qcTests), `products: { id: string; name: string }[]`
- State for filters: status (Select), productId (Select), source (Select for IN_HOUSE/CO_PACKER), dateFrom (date input), dateTo (date input)
- Filter bar at top: horizontal on desktop (flex-wrap), stacked on mobile
- Each filter is a shadcn Select or date Input
- "Clear Filters" button to reset all
- Client-side filtering of initialBatches (no server round-trip for filters -- data set is small for a hot sauce company)
- Table using shadcn Table component with columns:
  - Batch Code (link to /dashboard/production/{id})
  - Product (name + size)
  - Date (formatted with date-fns format)
  - Source ("In-House" or partner name)
  - Units
  - Status (BatchStatusBadge component)
- Mobile: On small screens (< md), switch to a card layout instead of table. Each batch is a Card showing batch code, product, status badge, date, units. Use responsive classes.
- Empty state: "No batches found" message with link to create new batch
- Sort by production date descending (most recent first)

**File 4: `src/app/(dashboard)/dashboard/production/page.tsx`** (server component, REPLACES existing placeholder)

Replace the existing placeholder content entirely:
- Import `verifySession` from dal.ts
- Import `getBatches`, `getProductionMetrics` from production actions
- Import `db` for fetching products list
- Call `await getBatches()` for all active batches
- Call `await getProductionMetrics()` for current month capacity
- Fetch products for filter dropdown: `db.product.findMany({ where: { isActive: true }, select: { id: true, name: true } })`
- Page layout:
  - Header row: "Production Tracking" title + "New Batch" button (Link to /dashboard/production/new, styled as primary Button)
  - CapacityMetrics component showing current month utilization
  - BatchList component with batches and products
- Use the same page structure pattern as other dashboard pages (space-y-6, h1 with text-3xl)
  </action>
  <verify>
1. Navigate to /dashboard/production — list page renders (no more placeholder)
2. "New Batch" button links to /dashboard/production/new
3. Capacity metrics shows current month stats (0/15000 if no batches yet)
4. Filter dropdowns render for status, product, source, date range
5. If batches exist, they appear in the table with correct status badges
6. On mobile viewport, batch cards render instead of table
7. `npx tsc --noEmit` passes
  </verify>
  <done>
Production list page replaces placeholder. BatchStatusBadge renders all 5 states with correct colors. BatchList shows filterable table/cards. CapacityMetrics displays utilization vs 15,000 target. All components compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create batch detail page with QC testing form and status transitions</name>
  <files>src/components/production/QCTestingForm.tsx, src/app/(dashboard)/dashboard/production/[id]/page.tsx</files>
  <action>
**File 1: `src/components/production/QCTestingForm.tsx`** (client component)

Create QC test entry form:
- 'use client' directive
- Import `useActionState` from 'react', `useFormStatus` from 'react-dom'
- Import `submitQCTest` from `@/app/actions/production`
- Props: `batchId: string`, `batchStatus: string`
- Two test types in tabs or sections:

  **pH Test Section:**
  - Input for pH level: type="number", step="0.1", min="0", max="14", inputMode="decimal", text-base
  - Show target range hint: "Target: 3.4-3.8 (must be < 4.6 for food safety)"
  - Auto-determines pass/fail: pH < 4.6 = pass, >= 4.6 = fail (show this logic visually)
  - Color indicator: green if in target range (3.4-3.8), yellow if safe but outside target (< 3.4 or 3.8-4.5), red if >= 4.6
  - Notes textarea (optional)
  - Hidden inputs: batchId, testType="pH"
  - Submit button: "Record pH Test"

  **Visual/Taste Test Section:**
  - Pass/Fail toggle: Two large buttons "Pass" (green) and "Fail" (red), mutually exclusive
  - Hidden input for passed value
  - Notes textarea (required if fail, optional if pass — add form-level validation message)
  - Hidden inputs: batchId, testType="visual_taste"
  - Submit button: "Record Visual/Taste Test"

- Use `useActionState(submitQCTest, undefined)` for form state
- Show success/error messages
- After successful submission, the page should revalidate (handled by server action's revalidatePath)
- Disable form if batch status is RELEASED (QC already complete)
- Show warning banner if batch is on HOLD: "This batch is on HOLD due to failed QC. Re-test to update status."

Mobile optimization: text-base inputs, h-11 touch targets, generous spacing.

**File 2: `src/app/(dashboard)/dashboard/production/[id]/page.tsx`** (server component)

Create the batch detail page:
- Import `getBatchById` from production actions
- Import `verifySession` from dal.ts
- Fetch batch by `params.id`, if not found return `notFound()` from next/navigation
- Import `updateBatchStatus` for status transition buttons

Page layout (single column, mobile-friendly):

1. **Header Section:**
   - Back link: "< Back to Production" linking to /dashboard/production
   - Batch code as h1 (e.g., "Batch 021726A")
   - BatchStatusBadge showing current status
   - "Created by {name} on {date}" subtitle

2. **Batch Details Card:**
   - Product: name + SKU + size
   - Production Date: formatted
   - Production Source: "In-House" or "Co-Packer: {partner name}"
   - If co-packer: Partner Lot Number, Receiving Date
   - Total Units produced
   - Notes (if any)

3. **Status Transition Section** (only for non-RELEASED, non-HOLD batches):
   - Show available next status as a button
   - PLANNED -> "Start Production" button (transitions to IN_PROGRESS)
   - IN_PROGRESS -> "Send to QC Review" button (transitions to QC_REVIEW)
   - HOLD -> "Re-submit for QC Review" button (transitions to QC_REVIEW)
   - Use a form with hidden inputs (batchId, status) and the updateBatchStatus server action
   - Buttons styled appropriately (primary for forward, warning for re-submit)

4. **QC Testing Section** (shown when status is QC_REVIEW or HOLD):
   - QCTestingForm component
   - Below the form, show QC Test History table:
     - List all existing QC tests for this batch
     - Columns: Test Type, Result (Pass/Fail badge), pH Level (if pH test), Notes, Tested By, Date
     - Most recent first

5. **Location Allocations Section** (shown if allocations exist):
   - Simple table: Location Name, Quantity
   - Total row at bottom

6. **Immutability Notice** (always shown at bottom):
   - Info banner: "Batch records are retained permanently for regulatory compliance and cannot be deleted."
   - No delete button anywhere on this page (PROD-14)

Use Card components for each section. Responsive: full-width cards stacked vertically.
  </action>
  <verify>
1. Navigate to /dashboard/production/{batchId} — detail page renders with all batch information
2. Status transition buttons appear for appropriate statuses (e.g., "Start Production" for PLANNED)
3. Clicking transition button updates status and page refreshes
4. QC Testing form appears for QC_REVIEW and HOLD statuses
5. Submit pH test with value < 4.6 — test recorded as passed
6. Submit pH test with value >= 4.6 — batch moves to HOLD
7. Submit visual/taste test — test recorded with pass/fail
8. QC test history shows all submitted tests
9. No delete button or destructive action exists on the page
10. `npx tsc --noEmit` passes
  </verify>
  <done>
Batch detail page shows complete batch information with QC testing forms. Status transitions work through the defined workflow. pH tests auto-determine pass/fail with food safety threshold. QC test history displays all submitted tests. No delete functionality exists. Page is mobile-optimized with stacked cards.
  </done>
</task>

</tasks>

<verification>
1. /dashboard/production shows batch list with filters (replaces "Coming in Phase 2" placeholder)
2. Capacity metrics widget displays 0/15,000 or actual data for current month
3. Clicking a batch code navigates to /dashboard/production/{id}
4. Batch detail shows all information: product, source, dates, units, notes, allocations
5. QC testing form submits pH and visual/taste tests
6. Failed QC (pH >= 4.6 or visual/taste fail) puts batch on HOLD
7. All QC tests for batch appear in history table
8. Status badge colors match: blue (Planned), yellow (In Progress), purple (QC Review), green (Released), red (Hold)
9. No batch deletion is possible anywhere in the UI
</verification>

<success_criteria>
- Production list page is functional with filterable batch table and card layout for mobile
- Batch detail page shows complete information and supports QC testing workflow
- Status transitions follow defined state machine (PLANNED -> IN_PROGRESS -> QC_REVIEW -> RELEASED/HOLD)
- pH test auto-fails if >= 4.6 (food safety)
- Capacity utilization shows against 15,000 unit/month target
- All batch records are immutable (no delete option)
- All TypeScript files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-quality-control/02-03-SUMMARY.md`
</output>
