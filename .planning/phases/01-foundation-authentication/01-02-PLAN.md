---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - prisma/schema.prisma
  - prisma/seed.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Prisma schema validates and migrations run successfully"
    - "Database contains all 6 products with pricing tiers and volume discounts"
    - "Database contains all 7 locations"
    - "Database contains all 9 sales channels"
    - "Database contains 2 admin users (Anthony and Tunde)"
    - "Database contains subscription plan configurations"
    - "Database contains approval workflow thresholds"
    - "Seed script is idempotent (can run multiple times without errors or duplicates)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Database models for User, Product, Location, SalesChannel, SubscriptionPlan, ApprovalThreshold"
      contains: "model User"
    - path: "prisma/seed.ts"
      provides: "Idempotent seed script for all reference data"
      contains: "upsert"
  key_links:
    - from: "prisma/seed.ts"
      to: "prisma/schema.prisma"
      via: "Prisma client uses schema models"
      pattern: "prisma\\.(user|product|location|salesChannel)\\."
    - from: "src/lib/db.ts"
      to: "prisma/schema.prisma"
      via: "PrismaClient generated from schema"
      pattern: "new PrismaClient"
---

<objective>
Create the complete Prisma schema with all foundational models and seed the database with complete reference data for all 6 products, 7 locations, 9 sales channels, 2 admin users, subscription plans, and approval thresholds.

Purpose: All subsequent plans (auth, dashboards, operations) depend on having a validated database schema and seeded reference data. This plan focuses exclusively on data modeling and seeding.
Output: Prisma schema with all models, migrations applied, and fully seeded database.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Prisma schema with all foundational models</name>
  <files>
    prisma/schema.prisma
  </files>
  <action>
    Define the complete Prisma schema in `prisma/schema.prisma` with these models:

    **Enums:**
    - `Role`: ADMIN, MANAGER, SALES_REP, INVESTOR
    - `LocationType`: PRODUCTION, RESTAURANT, WAREHOUSE, FULFILLMENT, MARKET, EVENT
    - `ChannelType`: ONLINE, RETAIL, WHOLESALE, MARKETPLACE, SUBSCRIPTION, EVENT

    **Models:**

    `User`:
    - id (String, cuid), email (String, unique), name (String), password (String, nullable for magic link users)
    - role (Role, default SALES_REP), emailVerified (DateTime, nullable), isActive (Boolean, default true)
    - createdAt, updatedAt
    - relations: invitesSent (InviteToken[])

    `Product`:
    - id (String, cuid), name (String), sku (String, unique), size (String), unitsPerCase (Int, nullable)
    - description (String, nullable), isActive (Boolean, default true)
    - createdAt, updatedAt
    - relations: pricingTiers (PricingTier[])

    `PricingTier`:
    - id (String, cuid), productId (String, FK to Product)
    - tierName (String) — e.g., "Wholesale Cash", "Wholesale Net 30", "Retail"
    - unitPrice (Decimal 10,2), casePrice (Decimal 10,2, nullable)
    - createdAt, updatedAt
    - Unique constraint on [productId, tierName]

    `VolumeDiscount`:
    - id (String, cuid), minCases (Int), maxCases (Int, nullable), discountPercent (Decimal 5,2)
    - description (String)
    - createdAt, updatedAt

    `FrequencyDiscount`:
    - id (String, cuid), frequency (String) — "quarterly" or "annual"
    - discountPercent (Decimal 5,2), additionalBenefits (String, nullable)
    - createdAt, updatedAt

    `Location`:
    - id (String, cuid), name (String, unique), type (LocationType)
    - address (String, nullable), description (String, nullable), isActive (Boolean, default true)
    - deliverySchedule (String, nullable) — e.g., "Weekly delivery"
    - createdAt, updatedAt

    `SalesChannel`:
    - id (String, cuid), name (String, unique), type (ChannelType)
    - description (String, nullable), isActive (Boolean, default true)
    - createdAt, updatedAt

    `SubscriptionPlan`:
    - id (String, cuid), name (String, unique), billingCycle (String) — "monthly" or "annual"
    - price (Decimal 10,2), includedProducts (String) — description of what's included
    - loyaltyReward (String, nullable) — e.g., "1 month free at 6 months"
    - cancellationPolicy (String, nullable)
    - isActive (Boolean, default true)
    - createdAt, updatedAt

    `ApprovalThreshold`:
    - id (String, cuid), minAmount (Decimal 10,2), maxAmount (Decimal 10,2, nullable)
    - approvalType (String) — "auto", "single_member", "dual_member", "dual_bank"
    - description (String)
    - createdAt, updatedAt

    `InviteToken`:
    - id (String, cuid), email (String), role (Role), token (String, unique)
    - invitedById (String, FK to User), expiresAt (DateTime)
    - acceptedAt (DateTime, nullable)
    - createdAt, updatedAt

    `MagicLinkToken`:
    - id (String, cuid), email (String), token (String, unique)
    - expiresAt (DateTime), usedAt (DateTime, nullable)
    - createdAt, updatedAt
  </action>
  <verify>
    ```bash
    npx prisma validate
    npx prisma migrate dev --name init
    ```
    Schema validates and migration creates all tables successfully.
  </verify>
  <done>
    - `npx prisma validate` passes without errors
    - `npx prisma migrate dev --name init` creates all tables
    - Schema contains all 11 models: User, Product, PricingTier, VolumeDiscount, FrequencyDiscount, Location, SalesChannel, SubscriptionPlan, ApprovalThreshold, InviteToken, MagicLinkToken
    - All enums defined: Role, LocationType, ChannelType
    - Unique constraints on email, sku, name (where specified), [productId, tierName]
  </done>
</task>

<task type="auto">
  <name>Task 2: Create idempotent seed script and populate database</name>
  <files>
    prisma/seed.ts
    package.json
  </files>
  <action>
    1. Create idempotent seed script in `prisma/seed.ts` using tsx runner:

    **Admin users (INFRA-04):**
    - Anthony Amos Jr.: anthony@jamaicahousebrand.com, ADMIN, bcrypt hash with cost 10
    - Olatunde Ogunjulugbe: tunde@jamaicahousebrand.com, ADMIN, bcrypt hash with cost 10
    - Use upsert by email to prevent duplicates
    - Default password: "JHB2026!" (users should change on first login)

    **Products with pricing tiers (INFRA-01):**
    Use exact data from PROJECT.md:
    - Original Jerk Sauce 2oz: sku JHB-OJS-2OZ, 25/case, Wholesale Cash $3.00/unit ($75/case), Retail $3.50-4.00 (use $3.75)
    - Original Jerk Sauce 5oz: sku JHB-OJS-5OZ, 12/case, Wholesale Cash $5.00/unit ($60/case), Wholesale Net 30 $6.25/unit ($75/case), Retail $7.00-8.00 (use $7.50)
    - Original Jerk Sauce 10oz: sku JHB-OJS-10OZ, 12/case, Wholesale Cash $10.00/unit ($110/case), Wholesale Net 30 $12.50/unit ($150/case), Retail $12.00-15.00 (use $13.50)
    - Escovitch/Pikliz 12oz: sku JHB-EP-12OZ, 12/case, Wholesale Cash $4.58/unit ($55/case), Retail $6.00-8.00 (use $7.00)
    - Original Jerk Sauce 1 Gallon: sku JHB-OJS-1GAL, 1/case, Wholesale Cash $80.00, Wholesale Net 30 $100.00 (intro price $50 first 3mo noted in description)
    - Original Jerk Sauce 9g Sachet: sku JHB-OJS-9G, null units/case (TBD), no pricing tiers yet

    For each product, upsert product first, then upsert each pricing tier by [productId, tierName] unique.

    **Volume discounts (INFRA-01):**
    - 1-5 cases: 0% (standard price)
    - 6-10 cases: 5% discount
    - 11+ cases: 10% discount

    **Frequency discounts (INFRA-01):**
    - Quarterly orders: 2% discount
    - Annual contracts: 5% discount + priority allocation

    **Locations (INFRA-02):**
    - Miami Gardens Restaurant: PRODUCTION, "Production facility + restaurant + retail"
    - Broward Blvd Restaurant: RESTAURANT, "Weekly delivery"
    - Miramar Restaurant: RESTAURANT, "Weekly delivery"
    - Amazon FBA Warehouse: FULFILLMENT, "E-commerce fulfillment"
    - Main Warehouse/Storage: WAREHOUSE, "Finished goods + raw materials"
    - Farmers Markets: MARKET, "Rotating South Florida locations"
    - Event/Tailgate Locations: EVENT, "Pop-up sales"

    **Sales channels (INFRA-03):**
    - Amazon: MARKETPLACE
    - Restaurant Retail: RETAIL
    - Wholesale/Distribution: WHOLESALE
    - Farmers Markets: EVENT
    - E-commerce/Website: ONLINE
    - Etsy: MARKETPLACE
    - Subscription/Membership: SUBSCRIPTION
    - Catering: WHOLESALE
    - Events/Tailgates: EVENT

    **Subscription plans (INFRA-05):**
    - Standard Annual: $75/yr, 1x 5oz monthly + gift bottle, loyalty: 1 month free at 6 months
    - Premium Annual: $125/yr, 1x 10oz monthly + gift bottle, loyalty: 1 month free at 6 months
    - Standard Monthly: $13/mo, 2x 5oz monthly
    - Premium Monthly: $20/mo, 2x 10oz monthly
    - All: cancellation requires 30 days written notice

    **Approval thresholds (INFRA-06):**
    - Under $150: auto-approve
    - $150-$500: single_member approval + notification
    - $500-$2,500: dual_member authorization
    - Over $2,500: dual_bank authorization

    2. Add seed command to `package.json`:
    ```json
    "prisma": {
      "seed": "tsx prisma/seed.ts"
    }
    ```

    3. Run seed:
    ```bash
    npx prisma db seed
    ```
  </action>
  <verify>
    ```bash
    npx prisma db seed
    npx prisma db seed
    ```
    Seed runs successfully twice without errors or duplicates (idempotency test). Verify row counts:
    - Users: 2 rows (Anthony, Tunde) with ADMIN role
    - Products: 6 rows with correct SKUs
    - PricingTiers: multiple rows per product matching PROJECT.md pricing
    - Locations: 7 rows
    - SalesChannels: 9 rows
    - SubscriptionPlans: 4 rows
    - ApprovalThresholds: 4 rows
    - VolumeDiscounts: 3 rows
    - FrequencyDiscounts: 2 rows
  </verify>
  <done>
    - `npx prisma db seed` populates all reference data without errors
    - Running seed twice produces no errors or duplicates (idempotent)
    - Users table: 2 admin users with hashed passwords
    - Products table: 6 products with correct SKUs, sizes, units per case
    - PricingTiers: All pricing tiers per PROJECT.md (wholesale cash, wholesale net 30, retail)
    - VolumeDiscounts: 3 tiers (1-5, 6-10, 11+)
    - FrequencyDiscounts: 2 tiers (quarterly, annual)
    - Locations: 7 locations with correct types
    - SalesChannels: 9 channels with correct types
    - SubscriptionPlans: 4 plans with correct pricing and benefits
    - ApprovalThresholds: 4 thresholds matching Operating Agreement rules
  </done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes
- `npx prisma migrate dev --name init` succeeds
- `npx prisma db seed` runs idempotently (no errors on second run)
- All 6 products, 7 locations, 9 channels, 2 users, 4 plans, 4 thresholds exist in database
</verification>

<success_criteria>
1. Prisma schema contains User, Product, PricingTier, VolumeDiscount, FrequencyDiscount, Location, SalesChannel, SubscriptionPlan, ApprovalThreshold, InviteToken, MagicLinkToken models
2. Database seeded with complete reference data matching PROJECT.md exactly
3. Seed script is idempotent (can run multiple times safely)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
