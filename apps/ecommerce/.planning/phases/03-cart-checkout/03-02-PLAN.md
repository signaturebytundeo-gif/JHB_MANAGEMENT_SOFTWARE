---
phase: 03-cart-checkout
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/stripe.ts
  - src/app/api/checkout/route.ts
  - src/app/api/webhooks/stripe/route.ts
  - src/app/success/page.tsx
  - src/components/CartDrawer.tsx
  - .env.local
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing for checkout"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (use test mode key: sk_test_...)"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key (use test mode key: pk_test_...)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Run `stripe listen --forward-to localhost:3000/api/webhooks/stripe` and copy the whsec_... value, OR Stripe Dashboard -> Developers -> Webhooks -> Signing secret for production"
    dashboard_config:
      - task: "Create a Stripe account at stripe.com if not already done"
        location: "https://dashboard.stripe.com/register"
      - task: "Install Stripe CLI for local webhook testing"
        location: "https://docs.stripe.com/stripe-cli"

must_haves:
  truths:
    - "Clicking checkout redirects to Stripe Checkout with correct line items and prices"
    - "Stripe Checkout supports credit card, Apple Pay, and Google Pay"
    - "After successful payment, order confirmation page displays with order details"
    - "Stripe webhook confirms payment on backend and logs the event"
    - "Cart is cleared only after payment is confirmed on success page"
  artifacts:
    - path: "src/lib/stripe.ts"
      provides: "Server-only Stripe SDK instance"
      contains: "server-only"
    - path: "src/app/api/checkout/route.ts"
      provides: "POST endpoint creating Stripe Checkout Session"
      exports: ["POST"]
    - path: "src/app/api/webhooks/stripe/route.ts"
      provides: "POST endpoint for Stripe webhook events"
      exports: ["POST"]
    - path: "src/app/success/page.tsx"
      provides: "Order confirmation page"
      contains: "session_id"
  key_links:
    - from: "src/components/CartDrawer.tsx"
      to: "src/app/api/checkout/route.ts"
      via: "fetch POST /api/checkout with cart items"
      pattern: "fetch.*api/checkout"
    - from: "src/app/api/checkout/route.ts"
      to: "src/lib/stripe.ts"
      via: "stripe.checkout.sessions.create"
      pattern: "stripe\\.checkout\\.sessions\\.create"
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "src/lib/stripe.ts"
      via: "stripe.webhooks.constructEvent for signature verification"
      pattern: "webhooks\\.constructEvent"
    - from: "src/app/success/page.tsx"
      to: "src/lib/stripe.ts"
      via: "stripe.checkout.sessions.retrieve to display order"
      pattern: "sessions\\.retrieve"
    - from: "src/app/success/page.tsx"
      to: "src/lib/cart-store.ts"
      via: "Client component clears cart after confirmed payment"
      pattern: "clearCart"
---

<objective>
Implement Stripe payment flow: checkout session creation, webhook signature verification, and order confirmation page. Wire the CartDrawer checkout button to redirect to Stripe Checkout, and display order details after successful payment.

Purpose: Enable users to complete purchases securely via Stripe Checkout with credit card, Apple Pay, and Google Pay support.
Output: Working end-to-end payment flow from cart to order confirmation.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cart-checkout/03-RESEARCH.md
@.planning/phases/03-cart-checkout/03-01-SUMMARY.md

Key files from Plan 03-01:
@src/lib/cart-store.ts (cart state with clearCart action)
@src/components/CartDrawer.tsx (checkout button placeholder to wire)
@src/lib/utils.ts (formatPrice utility)
@src/types/product.ts (Product interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe server instance, checkout API route, and wire CartDrawer checkout button</name>
  <files>
    src/lib/stripe.ts
    src/app/api/checkout/route.ts
    src/components/CartDrawer.tsx
    .env.local
  </files>
  <action>
    **Create `.env.local`** with placeholder environment variables:
    ```
    # Stripe API Keys (replace with your test keys from https://dashboard.stripe.com/test/apikeys)
    STRIPE_SECRET_KEY=sk_test_placeholder
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_placeholder
    STRIPE_WEBHOOK_SECRET=whsec_placeholder
    ```

    **Create `src/lib/stripe.ts`** — Server-only Stripe instance:
    - `import 'server-only'` at top to prevent client-side import
    - `import Stripe from 'stripe'`
    - Export `const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { typescript: true })`
    - Do NOT hardcode the apiVersion — let the SDK use its bundled default (the research example used a specific version but the SDK default is always compatible)

    **Create `src/app/api/checkout/route.ts`** — POST endpoint:
    - Import `NextRequest, NextResponse` from `next/server`
    - Import `stripe` from `@/lib/stripe`
    - Define request body type: `{ items: Array<{ id: string, name: string, price: number, quantity: number, image: string, size: string }> }`
    - Validate that items array is non-empty, return 400 if empty
    - Create Stripe Checkout Session:
      ```typescript
      const session = await stripe.checkout.sessions.create({
        payment_method_types: ['card'],
        line_items: items.map((item) => ({
          price_data: {
            currency: 'usd',
            product_data: {
              name: `${item.name} (${item.size})`,
              images: item.image.startsWith('http') ? [item.image] : [],
              // Only include absolute URLs for images — relative paths won't work in Stripe
            },
            unit_amount: item.price, // Already in cents — do NOT multiply by 100
          },
          quantity: item.quantity,
        })),
        mode: 'payment',
        success_url: `${request.headers.get('origin')}/success?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${request.headers.get('origin')}/shop`,
        metadata: {
          source: 'jamaica-house-brand-web',
        },
      })
      ```
    - Return `NextResponse.json({ url: session.url })`
    - Wrap in try/catch, return 500 with error message on failure

    **Update `src/components/CartDrawer.tsx`** — Wire checkout button:
    - Add `isCheckingOut` state (useState, default false) for loading state
    - Replace placeholder checkout handler with:
      ```typescript
      async function handleCheckout() {
        setIsCheckingOut(true)
        try {
          const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items }),
          })
          const data = await response.json()
          if (data.url) {
            window.location.href = data.url
          } else {
            console.error('No checkout URL returned')
            setIsCheckingOut(false)
          }
        } catch (error) {
          console.error('Checkout error:', error)
          setIsCheckingOut(false)
        }
      }
      ```
    - Update checkout button: disabled when `isCheckingOut || items.length === 0`
    - Show loading state: when isCheckingOut, button text changes to "Redirecting..." with reduced opacity
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    Verify files exist: `ls src/lib/stripe.ts src/app/api/checkout/route.ts .env.local`
    Verify server-only import: `grep "server-only" src/lib/stripe.ts`
    Verify checkout session creation: `grep "checkout.sessions.create" src/app/api/checkout/route.ts`
    Verify CartDrawer wired: `grep "api/checkout" src/components/CartDrawer.tsx`
  </verify>
  <done>
    Stripe SDK instance created with server-only guard. Checkout API route creates Stripe session with cart items at correct prices (cents). CartDrawer checkout button sends items to API and redirects to Stripe Checkout. Loading state shown during redirect. Environment variables templated in .env.local.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe webhook handler and order confirmation success page</name>
  <files>
    src/app/api/webhooks/stripe/route.ts
    src/app/success/page.tsx
  </files>
  <action>
    **Create `src/app/api/webhooks/stripe/route.ts`** — Webhook handler:
    - Import `NextRequest, NextResponse` from `next/server`
    - Import `stripe` from `@/lib/stripe`
    - Read `STRIPE_WEBHOOK_SECRET` from `process.env`
    - Export async POST function:
      1. Get raw body with `await request.text()` — CRITICAL: do NOT use `request.json()` as it breaks signature verification
      2. Get signature from `request.headers.get('stripe-signature')`
      3. If no signature, return 400
      4. Call `stripe.webhooks.constructEvent(body, signature, webhookSecret)` in try/catch
      5. On verification failure, log error and return 400 `{ error: 'Invalid signature' }`
      6. Handle event types:
         - `checkout.session.completed`: Log order details (session ID, payment status, amount total, customer email from `session.customer_details?.email`). This is the source of truth for payment confirmation. In production, this would trigger order fulfillment, email confirmation, etc.
         - Default: Log unhandled event type (not an error, just informational)
      7. Return 200 `{ received: true }` immediately — Stripe requires fast response
    - Add idempotency note as code comment: in production, check `event.id` against a processed events store to prevent duplicate processing

    **Create `src/app/success/page.tsx`** — Order confirmation page:
    - This is a Server Component that retrieves the Stripe session
    - Import `stripe` from `@/lib/stripe`
    - Import `Metadata` from `next`
    - Export metadata: `{ title: 'Order Confirmed | Jamaica House Brand' }`
    - Page receives `searchParams: Promise<{ session_id?: string }>` (Next.js 16 async searchParams)
    - Await searchParams, extract `session_id`
    - If no session_id, show "No order found" message with link back to /shop
    - Retrieve session: `await stripe.checkout.sessions.retrieve(session_id, { expand: ['line_items'] })`
    - If session status is not 'complete', show "Payment not completed" with link to /shop
    - Display order confirmation:
      - Large checkmark icon (SVG circle with check) in brand gold
      - "Order Confirmed!" heading (text-3xl font-bold)
      - "Thank you for your purchase" subtext
      - If customer email available: "A confirmation will be sent to {email}"
      - Order summary section:
        - List each line item from `session.line_items?.data`: name, quantity, amount (format from cents)
        - Amount total: `formatPrice(session.amount_total ?? 0)`
      - "Continue Shopping" button linking to /shop (bg-brand-gold styling)
    - Style: centered layout, max-w-lg, dark theme consistent with rest of site
    - Create a Client Component `ClearCartOnSuccess` that:
      - Renders as a child of the success page (no visible UI)
      - On mount (useEffect), calls `useCartStore.getState().clearCart()`
      - This ensures cart is only cleared AFTER user reaches success page with confirmed payment — NOT on checkout click (per pitfall #3 from research)
    - Include `<ClearCartOnSuccess />` in the success page layout
    - The ClearCartOnSuccess component can be defined in the same file as a separate `'use client'` component, or in a separate file. Prefer inline since it's tiny (3-4 lines of logic).
    - Since it's a Server Component file that needs a Client Component child, create `src/components/ClearCartOnSuccess.tsx` as a separate Client Component file.

    **Important notes:**
    - Prices from Stripe session are already in cents — use `formatPrice()` for display
    - The success page is the ONLY place cart is cleared, ensuring no data loss on failed/cancelled payments
    - Webhook logging is sufficient for MVP — no database needed yet (per research recommendation)
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    Run `npm run build` — build succeeds.
    Verify files exist: `ls src/app/api/webhooks/stripe/route.ts src/app/success/page.tsx src/components/ClearCartOnSuccess.tsx`
    Verify webhook uses raw body: `grep "request.text()" src/app/api/webhooks/stripe/route.ts`
    Verify signature verification: `grep "constructEvent" src/app/api/webhooks/stripe/route.ts`
    Verify success page retrieves session: `grep "sessions.retrieve" src/app/success/page.tsx`
    Verify cart clearing: `grep "clearCart" src/components/ClearCartOnSuccess.tsx`
  </verify>
  <done>
    Webhook handler verifies Stripe signatures using raw body text, logs checkout.session.completed events. Success page retrieves Stripe session, displays order confirmation with checkmark, line items, total, and customer email. Cart is cleared only on success page mount (not on checkout click). Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npx tsc --noEmit` passes with zero errors
3. Stripe server instance guarded with server-only: `grep "server-only" src/lib/stripe.ts`
4. Checkout API creates session: `grep "checkout.sessions.create" src/app/api/checkout/route.ts`
5. Webhook uses raw body: `grep "request.text" src/app/api/webhooks/stripe/route.ts`
6. Webhook verifies signature: `grep "constructEvent" src/app/api/webhooks/stripe/route.ts`
7. Success page retrieves session: `grep "sessions.retrieve" src/app/success/page.tsx`
8. Cart cleared on success only: `grep "clearCart" src/components/ClearCartOnSuccess.tsx`
9. CartDrawer POSTs to checkout API: `grep "api/checkout" src/components/CartDrawer.tsx`
10. Environment variables file exists: `test -f .env.local`
</verification>

<success_criteria>
- Checkout button in CartDrawer sends cart items to /api/checkout and redirects to Stripe Checkout
- Stripe Checkout session contains correct product names (with sizes), prices in cents, and quantities
- Webhook endpoint verifies Stripe signature using raw body text
- Webhook logs checkout.session.completed events with order details
- Success page shows order confirmation with checkmark, line items, total, and email
- Cart is cleared only after reaching success page (not on checkout click)
- All env vars documented in .env.local with placeholder values
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-cart-checkout/03-02-SUMMARY.md`
</output>
