---
phase: 02-production-quality-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/seed.ts
  - src/lib/validators/production.ts
  - src/lib/utils/batch-code.ts
autonomous: true

must_haves:
  truths:
    - "Prisma schema contains Batch, QCTest, CoPackerPartner, RawMaterial, BatchMaterial, and BatchAllocation models"
    - "Batch status enum has all 5 states: PLANNED, IN_PROGRESS, QC_REVIEW, RELEASED, HOLD"
    - "ProductionSource enum has IN_HOUSE and CO_PACKER values"
    - "Batch model has isActive field defaulting to true and no cascading deletes (soft delete only)"
    - "Zod validators enforce pH range, allocation sum, and conditional co-packer fields"
    - "Batch code generator produces MMDDYY format with letter suffixes for same-day duplicates"
    - "Seed data includes Space Coast Sauces and Tabanero Holdings as co-packer partners"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Production models with enums, relations, and indexes"
      contains: "model Batch"
    - path: "src/lib/validators/production.ts"
      provides: "Zod schemas for batch creation, QC testing, raw materials"
      exports: ["createBatchSchema", "qcTestSchema", "rawMaterialSchema"]
    - path: "src/lib/utils/batch-code.ts"
      provides: "MMDDYY batch code generation with collision handling"
      exports: ["generateBatchCode"]
    - path: "prisma/seed.ts"
      provides: "Seed data for co-packer partners"
      contains: "Space Coast Sauces"
  key_links:
    - from: "prisma/schema.prisma"
      to: "src/generated/prisma"
      via: "prisma generate"
      pattern: "model Batch"
    - from: "src/lib/validators/production.ts"
      to: "prisma/schema.prisma"
      via: "enum imports from @prisma/client"
      pattern: "import.*BatchStatus.*from.*@prisma/client"
---

<objective>
Create the database foundation for production tracking: Prisma models for batches, QC tests, co-packer partners, raw materials, and location allocations, plus Zod validation schemas and the MMDDYY batch code generation utility.

Purpose: Everything in Phase 2 depends on these models, validators, and utilities. This is the foundation that all other plans build on.
Output: Updated Prisma schema with new models, Zod validators, batch code utility, seed data for co-packer partners.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/lib/validators/auth.ts
@src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add production Prisma models and enums</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following enums and models to the EXISTING schema.prisma (append after the existing models, do NOT remove anything):

**Enums to add:**
```
enum BatchStatus {
  PLANNED
  IN_PROGRESS
  QC_REVIEW
  RELEASED
  HOLD
}

enum ProductionSource {
  IN_HOUSE
  CO_PACKER
}
```

**Models to add:**

1. `CoPackerPartner` ‚Äî configurable partner list (PROD-10):
   - id (String @id @default(cuid()))
   - name (String @unique)
   - contactName (String?)
   - email (String?)
   - phone (String?)
   - address (String?)
   - isActive (Boolean @default(true))
   - createdAt, updatedAt
   - batches relation to Batch[]
   - Indexes: [name], [isActive]

2. `Batch` ‚Äî core production batch (PROD-01, 02, 06, 14):
   - id (String @id @default(cuid()))
   - batchCode (String @unique) ‚Äî auto-generated MMDDYY + letter
   - productId (String) ‚Äî relation to Product
   - productionDate (DateTime @default(now()))
   - productionSource (ProductionSource)
   - status (BatchStatus @default(PLANNED))
   - totalUnits (Int)
   - notes (String?)
   - coPackerPartnerId (String?) ‚Äî nullable, only for CO_PACKER source
   - coPackerLotNumber (String?) ‚Äî partner's lot number
   - coPackerReceivingDate (DateTime?) ‚Äî when received from co-packer
   - createdById (String) ‚Äî who created it
   - isActive (Boolean @default(true)) ‚Äî soft delete for immutability (PROD-14)
   - deletedAt (DateTime?)
   - deletedReason (String?)
   - createdAt, updatedAt
   - Relations: product (Product), coPackerPartner (CoPackerPartner?), createdBy (User), qcTests (QCTest[]), allocations (BatchAllocation[]), materials (BatchMaterial[])
   - Indexes: [batchCode], [productId], [status], [productionDate], [isActive], [coPackerPartnerId]

   IMPORTANT: Add a `batches Batch[]` relation field to the existing Product model and User model. For User, name the relation field `createdBatches` to avoid conflicts with other potential relations.

3. `QCTest` ‚Äî quality control test records (PROD-04, 05):
   - id (String @id @default(cuid()))
   - batchId (String)
   - testType (String) ‚Äî "pH" or "visual_taste"
   - phLevel (Decimal?) ‚Äî for pH tests, precision to 0.1
   - passed (Boolean)
   - notes (String?)
   - testedById (String) ‚Äî who performed test
   - createdAt, updatedAt
   - Relations: batch (Batch), testedBy (User)
   - Indexes: [batchId], [testType]

   Add `qcTests QCTest[]` relation to User model (field name: `conductedQCTests`).

4. `BatchAllocation` ‚Äî optional location distribution (PROD-08):
   - id (String @id @default(cuid()))
   - batchId (String)
   - locationId (String)
   - quantity (Int)
   - createdAt, updatedAt
   - Relations: batch (Batch), location (Location)
   - @@unique([batchId, locationId])
   - Indexes: [batchId], [locationId]

   Add `batchAllocations BatchAllocation[]` relation to Location model.

5. `RawMaterial` ‚Äî ingredient tracking (PROD-09):
   - id (String @id @default(cuid()))
   - name (String)
   - supplier (String)
   - lotNumber (String)
   - expirationDate (DateTime)
   - receivedDate (DateTime)
   - quantity (Decimal)
   - unit (String) ‚Äî e.g., "kg", "lbs", "liters"
   - isActive (Boolean @default(true))
   - createdAt, updatedAt
   - batchMaterials relation to BatchMaterial[]
   - Indexes: [name], [supplier], [lotNumber], [isActive]

6. `BatchMaterial` ‚Äî join table linking batches to raw materials (PROD-09):
   - id (String @id @default(cuid()))
   - batchId (String)
   - rawMaterialId (String)
   - quantityUsed (Decimal)
   - createdAt, updatedAt
   - Relations: batch (Batch), rawMaterial (RawMaterial)
   - @@unique([batchId, rawMaterialId])

IMPORTANT NOTES FOR SQLITE:
- Do NOT use @db.Decimal or any @db.* annotations ‚Äî SQLite does not support them
- Decimal fields are fine without annotations (Prisma handles this)
- Do NOT use @db.Text for String fields

After updating schema.prisma, run:
```bash
npx prisma db push
npx prisma generate
```

This uses `db push` (not migrate) which is appropriate for SQLite development.
  </action>
  <verify>
Run `npx prisma db push --dry-run` to verify schema is valid. Then run `npx prisma generate` and confirm no errors. Check that `src/generated/prisma/enums.ts` contains BatchStatus and ProductionSource.
  </verify>
  <done>
All 6 models and 2 enums exist in schema.prisma. `npx prisma db push` succeeds. Prisma client is regenerated with new types. Existing models (User, Product, Location, etc.) have their new relation fields added without breaking anything.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validators, batch code utility, and seed co-packer partners</name>
  <files>src/lib/validators/production.ts, src/lib/utils/batch-code.ts, prisma/seed.ts</files>
  <action>
**File 1: `src/lib/validators/production.ts`**

Create Zod validation schemas following the pattern in `src/lib/validators/auth.ts`:

1. `createBatchSchema` ‚Äî validates batch creation:
   - productId: z.string().min(1, "Product is required")
   - productionDate: z.coerce.date() ‚Äî defaults to today
   - productionSource: z.nativeEnum(ProductionSource)
   - totalUnits: z.coerce.number().int().positive("Total units must be positive")
   - notes: z.string().optional()
   - coPackerPartnerId: z.string().optional()
   - coPackerLotNumber: z.string().optional()
   - coPackerReceivingDate: z.coerce.date().optional()
   - allocations: z.array(z.object({ locationId: z.string(), quantity: z.coerce.number().int().nonnegative() })).optional()
   - Add .refine(): when productionSource is CO_PACKER, coPackerPartnerId must be provided
   - Add .refine(): when allocations provided and non-empty, sum of allocation quantities must equal totalUnits
   - Import ProductionSource from @prisma/client

   Export type `CreateBatchFormState` matching the pattern:
   ```typescript
   export type CreateBatchFormState =
     | { errors?: Record<string, string[]>; message?: string; success?: boolean }
     | undefined;
   ```

2. `qcTestSchema` ‚Äî validates QC test submission:
   - batchId: z.string().min(1)
   - testType: z.enum(["pH", "visual_taste"])
   - phLevel: z.coerce.number().min(0).max(14).optional()
   - passed: z.coerce.boolean()
   - notes: z.string().optional()
   - Add .refine(): when testType is "pH", phLevel must be provided

   Export type `QCTestFormState` with same pattern.

3. `rawMaterialSchema` ‚Äî validates raw material creation:
   - name: z.string().min(1, "Name is required")
   - supplier: z.string().min(1, "Supplier is required")
   - lotNumber: z.string().min(1, "Lot number is required")
   - expirationDate: z.coerce.date()
   - receivedDate: z.coerce.date()
   - quantity: z.coerce.number().positive("Quantity must be positive")
   - unit: z.string().min(1, "Unit is required")

   Export type `RawMaterialFormState` with same pattern.

4. `coPackerPartnerSchema` ‚Äî validates partner creation:
   - name: z.string().min(1, "Name is required").max(100)
   - contactName: z.string().optional()
   - email: z.string().email().optional().or(z.literal(""))
   - phone: z.string().optional()
   - address: z.string().optional()

   Export type `CoPackerPartnerFormState` with same pattern.

5. `updateBatchStatusSchema` ‚Äî validates status transitions:
   - batchId: z.string().min(1)
   - status: z.nativeEnum(BatchStatus)

**File 2: `src/lib/utils/batch-code.ts`**

Create the directory `src/lib/utils/` if it doesn't exist (it should already exist since utils.ts is there ‚Äî but batch-code.ts is a new file).

Create the batch code generator:
```typescript
import { format } from 'date-fns';
import { db } from '@/lib/db';

/**
 * Generates a batch code in MMDDYY format with letter suffix for duplicates.
 * First batch of the day: 021726
 * Second batch: 021726A
 * Third batch: 021726B
 * etc.
 *
 * Uses a database transaction to prevent race conditions.
 */
export async function generateBatchCode(date: Date = new Date()): Promise<string> {
  const dateCode = format(date, 'MMddyy');

  // Find existing batches for this date code
  const existingBatches = await db.batch.findMany({
    where: {
      batchCode: {
        startsWith: dateCode,
      },
    },
    select: { batchCode: true },
    orderBy: { batchCode: 'asc' },
  });

  if (existingBatches.length === 0) {
    return dateCode;
  }

  // Find next available letter suffix
  // First batch has no suffix, subsequent ones get A, B, C, etc.
  const suffixIndex = existingBatches.length - 1;
  const suffix = String.fromCharCode(65 + suffixIndex); // A=65, B=66, etc.
  return `${dateCode}${suffix}`;
}
```

Note: Import `format` from `date-fns` which is already installed.

**File 3: `prisma/seed.ts`**

Add co-packer partner seed data to the EXISTING seed.ts file. Add a new section BEFORE the final success message. Follow the existing upsert pattern:

```typescript
// ============================================================================
// CO-PACKER PARTNERS (PROD-10)
// ============================================================================
console.log("üè≠ Seeding co-packer partners...");

await prisma.coPackerPartner.upsert({
  where: { name: "Space Coast Sauces" },
  update: {},
  create: {
    name: "Space Coast Sauces",
    contactName: null,
    email: null,
    phone: null,
    address: null,
    isActive: true,
  },
});

await prisma.coPackerPartner.upsert({
  where: { name: "Tabanero Holdings" },
  update: {},
  create: {
    name: "Tabanero Holdings",
    contactName: null,
    email: null,
    phone: null,
    address: null,
    isActive: true,
  },
});

console.log("‚úÖ Created/verified 2 co-packer partners");
```

Also add the CoPackerPartner import at the top of seed.ts ‚Äî it should already be imported via the bulk import from @prisma/client. Verify the import line includes all needed types.

After updating seed, run: `npx tsx prisma/seed.ts`
  </action>
  <verify>
1. Run `npx tsx prisma/seed.ts` and confirm "Created/verified 2 co-packer partners" appears
2. Verify `src/lib/validators/production.ts` exports: createBatchSchema, qcTestSchema, rawMaterialSchema, coPackerPartnerSchema, updateBatchStatusSchema
3. Verify `src/lib/utils/batch-code.ts` exports: generateBatchCode
4. Run `npx tsc --noEmit` (or the project's type check command) to verify no type errors
  </verify>
  <done>
Zod validators cover all production form inputs with proper refinements. Batch code utility generates MMDDYY codes with letter suffixes. Seed data includes both co-packer partners. All files pass TypeScript compilation.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` succeeds with all new models
2. `npx prisma generate` produces client with Batch, QCTest, CoPackerPartner, RawMaterial, BatchMaterial, BatchAllocation types
3. `npx tsx prisma/seed.ts` seeds co-packer partners without errors
4. TypeScript compilation passes with no errors in new files
5. BatchStatus enum has exactly 5 values: PLANNED, IN_PROGRESS, QC_REVIEW, RELEASED, HOLD
6. ProductionSource enum has exactly 2 values: IN_HOUSE, CO_PACKER
</verification>

<success_criteria>
- All 6 new Prisma models exist with correct fields, relations, and indexes
- Existing models (User, Product, Location) have new relation fields without breaking changes
- Zod schemas validate all production forms with conditional refinements
- Batch code generator produces correct MMDDYY format with letter suffixes
- Co-packer partners seeded in database
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-quality-control/02-01-SUMMARY.md`
</output>
