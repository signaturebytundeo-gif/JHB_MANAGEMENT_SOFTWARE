---
phase: 01-foundation-authentication
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - src/app/actions/auth.ts
  - src/app/(auth)/invite/[token]/page.tsx
  - src/app/(auth)/magic-link/page.tsx
  - src/app/api/auth/magic-link/verify/route.ts
  - src/app/(dashboard)/settings/users/page.tsx
  - src/app/(dashboard)/admin/page.tsx
  - src/app/(dashboard)/investor/page.tsx
  - src/app/(dashboard)/investor/layout.tsx
  - src/components/auth/InviteAcceptForm.tsx
  - src/components/auth/MagicLinkForm.tsx
  - src/components/dashboard/DashboardSkeleton.tsx
  - src/lib/validators/auth.ts
  - src/lib/integrations/email.ts
  - prisma/schema.prisma
autonomous: true
user_setup:
  - service: resend
    why: "Transactional emails for invite links and magic links"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify a sending domain or use development mode"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Admin can send invite link to a new user with a pre-assigned role"
    - "Invited user can click the link and set up their password to create an account"
    - "Invite links expire after 7 days"
    - "User can request a magic link, receive the email, click the link, and be logged in with a valid session and redirected to the correct dashboard"
    - "Magic links expire after 15 minutes and cannot be reused"
    - "Admin dashboard shows overview of all operations sections"
    - "Manager sees operations-focused view without finance/settings"
    - "Sales Rep sees orders and customers focus"
    - "Investor sees read-only metrics dashboard"
    - "Loading skeletons appear while dashboard data loads"
    - "Quick action buttons show disabled state with tooltip indicating future availability"
  artifacts:
    - path: "src/app/actions/auth.ts"
      provides: "Extended auth actions: sendInvite, acceptInvite, requestMagicLink"
      exports: ["login", "logout", "sendInvite", "acceptInvite", "requestMagicLink"]
    - path: "src/app/(auth)/invite/[token]/page.tsx"
      provides: "Invite acceptance page with password setup form"
      contains: "InviteAcceptForm"
    - path: "src/app/(auth)/magic-link/page.tsx"
      provides: "Magic link request page"
      contains: "MagicLinkForm"
    - path: "src/app/api/auth/magic-link/verify/route.ts"
      provides: "GET route handler to verify magic link token and create session"
      exports: ["GET"]
    - path: "src/app/(dashboard)/admin/page.tsx"
      provides: "Admin dashboard overview with all sections visible"
      contains: "DashboardSkeleton"
    - path: "src/app/(dashboard)/investor/page.tsx"
      provides: "Read-only investor dashboard with placeholder metrics"
      contains: "Investor"
    - path: "src/app/(dashboard)/settings/users/page.tsx"
      provides: "User management page with invite form (admin only)"
      contains: "sendInvite"
    - path: "src/components/dashboard/DashboardSkeleton.tsx"
      provides: "Loading skeleton component for dashboard cards"
      contains: "Skeleton"
    - path: "src/lib/integrations/email.ts"
      provides: "Email sending utility using Resend"
      exports: ["sendInviteEmail", "sendMagicLinkEmail"]
  key_links:
    - from: "src/app/actions/auth.ts"
      to: "src/lib/integrations/email.ts"
      via: "sendInvite action sends invite email"
      pattern: "sendInviteEmail"
    - from: "src/app/actions/auth.ts"
      to: "prisma/schema.prisma"
      via: "Actions create InviteToken and MagicLinkToken records"
      pattern: "db\\.(inviteToken|magicLinkToken)\\."
    - from: "src/app/(auth)/invite/[token]/page.tsx"
      to: "src/app/actions/auth.ts"
      via: "Invite page calls acceptInvite Server Action"
      pattern: "acceptInvite"
    - from: "src/app/api/auth/magic-link/verify/route.ts"
      to: "src/lib/session.ts"
      via: "Magic link verification creates session"
      pattern: "createSession"
    - from: "src/app/(dashboard)/settings/users/page.tsx"
      to: "src/app/actions/auth.ts"
      via: "User management page calls sendInvite"
      pattern: "sendInvite"
    - from: "src/app/(dashboard)/admin/page.tsx"
      to: "src/lib/dal.ts"
      via: "Admin page verifies admin role"
      pattern: "verifyAdmin"
---

<objective>
Implement the invite system for new users with pre-assigned roles, magic link authentication with explicit end-to-end verification, role-specific dashboard views for all 4 roles, user management page for admins, and loading skeletons for data-heavy views.

Purpose: This completes the authentication module -- admins can grow the user base via invites, users have password-free login option, and each role sees an appropriate view. Loading skeletons ensure the UI feels responsive even before real data modules exist.
Output: Working invite flow, magic link auth (fully tested), 4 role-specific dashboard views, user management page, loading skeletons.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement invite system and magic link authentication with end-to-end verification</name>
  <files>
    src/app/actions/auth.ts
    src/app/(auth)/invite/[token]/page.tsx
    src/app/(auth)/magic-link/page.tsx
    src/app/api/auth/magic-link/verify/route.ts
    src/components/auth/InviteAcceptForm.tsx
    src/components/auth/MagicLinkForm.tsx
    src/lib/validators/auth.ts
    src/lib/integrations/email.ts
  </files>
  <action>
    1. Create `src/lib/integrations/email.ts` -- Email sending utility:
       - Use Resend SDK (`npm install resend` if not already installed)
       - Initialize Resend with RESEND_API_KEY from env
       - `sendInviteEmail(to: string, inviterName: string, role: string, token: string)`:
         - Subject: "You've been invited to JHB Command Center"
         - Generate invite URL: `${NEXT_PUBLIC_APP_URL}/invite/${token}`
         - HTML email body with Caribbean branding (inline styles for email compatibility):
           - Green header (#006633), company name
           - "You've been invited by {inviterName} to join as a {role}"
           - CTA button: "Accept Invitation" linking to invite URL
           - "This link expires in 7 days"
           - Footer: Jamaica House Brand LLC
         - From: "JHB Command Center <onboarding@resend.dev>" (use resend.dev for development, custom domain for production)
         - If RESEND_API_KEY is not set, log email to console instead of sending (development fallback)
       - `sendMagicLinkEmail(to: string, token: string)`:
         - Subject: "Your sign-in link for JHB Command Center"
         - Generate magic link URL: `${NEXT_PUBLIC_APP_URL}/api/auth/magic-link/verify?token=${token}`
         - HTML email with same Caribbean branding
         - CTA button: "Sign In"
         - "This link expires in 15 minutes"
         - Same development fallback as above

    2. Extend `src/lib/validators/auth.ts` -- Add new schemas:
       - `inviteSchema`: email (string, email), role (nativeEnum matching Prisma Role enum)
       - `acceptInviteSchema`: password (string, min 8, must contain uppercase, lowercase, and number), confirmPassword (string). Refine: passwords must match
       - `magicLinkRequestSchema`: email (string, email)
       - Export InviteFormState, AcceptInviteFormState, MagicLinkFormState types

    3. Extend `src/app/actions/auth.ts` -- Add new Server Actions:
       - `sendInvite(prevState, formData)`:
         1. Verify admin role via verifyAdmin() from DAL
         2. Validate with inviteSchema
         3. Check if email already exists in User table -- return error if so
         4. Generate random token with `crypto.randomUUID()`
         5. Set expiresAt to 7 days from now
         6. Get current user for inviterName
         7. Create InviteToken record (upsert by email to allow re-inviting)
         8. Call sendInviteEmail
         9. Return { success: true, message: 'Invite sent to {email}' }
       - `acceptInvite(prevState, formData)`:
         1. Get token from formData
         2. Validate password with acceptInviteSchema
         3. Find InviteToken by token where expiresAt > now AND acceptedAt is null
         4. If not found/expired: return { message: 'Invite link is invalid or has expired' }
         5. Hash password with bcrypt (cost 10)
         6. Create User with email, name (from email prefix), role from invite, hashed password
         7. Update InviteToken: set acceptedAt to now
         8. Create session for new user
         9. Redirect to getRoleDashboard(role)
       - `requestMagicLink(prevState, formData)`:
         1. Validate with magicLinkRequestSchema
         2. Find user by email
         3. If no user: return { success: true, message: 'If an account exists, a sign-in link has been sent' } (don't reveal if email exists)
         4. Generate random token with crypto.randomUUID()
         5. Set expiresAt to 15 minutes from now
         6. Create MagicLinkToken record
         7. Call sendMagicLinkEmail
         8. Return same generic success message

    4. Create `src/app/api/auth/magic-link/verify/route.ts` -- Magic link verification:
       - GET handler
       - Read token from URL searchParams
       - Find MagicLinkToken where token matches, expiresAt > now, usedAt is null
       - If invalid: redirect to /login with error query param
       - Mark token as used: update usedAt to now
       - Find user by email from token record
       - If user not found or user.isActive is false: redirect to /login with error
       - Create session for user (call createSession with user.id and user.role)
       - Redirect to getRoleDashboard(user.role)

    5. Create `src/components/auth/InviteAcceptForm.tsx` -- Invite acceptance form:
       - 'use client' directive
       - Props: token (string), email (string), role (string)
       - Show: "You've been invited to join JHB Command Center as a {role}"
       - Show email (read-only)
       - Password field + Confirm Password field
       - Password requirements display (8+ chars, uppercase, lowercase, number)
       - Submit button: "Create Account"
       - Use useActionState with acceptInvite action
       - Hidden field for token
       - Caribbean styling matching login page

    6. Create `src/app/(auth)/invite/[token]/page.tsx` -- Invite acceptance page:
       - Server Component
       - Read token from params
       - Query InviteToken by token to get email and role
       - If token invalid/expired: show error message with link back to login
       - If valid: render InviteAcceptForm with token, email, role props

    7. Create `src/components/auth/MagicLinkForm.tsx` -- Magic link request form:
       - 'use client' directive
       - Email field only
       - Submit button: "Send Sign-In Link"
       - Success state: show "Check your email for a sign-in link" message
       - Use useActionState with requestMagicLink action
       - Caribbean styling

    8. Create `src/app/(auth)/magic-link/page.tsx` -- Magic link page:
       - Import MagicLinkForm
       - Add link: "Or sign in with password" -> /login
       - On login page, add link: "Or sign in with magic link" -> /magic-link
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    npm run build
    ```
    TypeScript compiles and build succeeds. Then test the complete magic link flow end-to-end:

    1. Start dev server: `npm run dev &`
    2. **Magic link full flow (AUTH-02 explicit verification):**
       a. Request magic link: Visit /magic-link, enter anthony@jamaicahousebrand.com, submit
       b. Capture the magic link token from console output (dev fallback logs it)
       c. Visit the magic link verification URL: `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" "http://localhost:3000/api/auth/magic-link/verify?token={TOKEN}"`
       d. Verify: response is 307 redirect to /dashboard (session created successfully)
       e. Verify session cookie is set: the redirect response includes a Set-Cookie header with 'session' cookie
       f. Visit the same magic link URL again: should redirect to /login with error (token already used, single-use enforced)
    3. **Invite flow test:**
       a. Log in as Anthony (admin)
       b. Navigate to /settings/users (built in Task 2)
       c. Send invite to test@example.com with SALES_REP role
       d. Check console for invite email (dev mode without RESEND_API_KEY)
       e. Visit invite URL -- should show acceptance form
       f. Set password and submit -- should create account and redirect to dashboard
    4. Kill dev server.
  </verify>
  <done>
    - sendInvite Server Action: validates admin role, creates InviteToken, sends email
    - acceptInvite Server Action: validates token, creates user with hashed password, creates session
    - requestMagicLink Server Action: creates MagicLinkToken, sends email (doesn't reveal if email exists)
    - Magic link verification endpoint: validates token, marks as used, creates session, redirects to correct dashboard
    - Magic link login verified end-to-end: request link -> token created -> verification endpoint creates session -> user redirected to dashboard
    - Magic link tokens are single-use: second visit to same link redirects to /login with error
    - Invite acceptance page: shows form with email/role info, password setup
    - Magic link page: email-only form for passwordless sign-in
    - Invite tokens expire after 7 days
    - Magic link tokens expire after 15 minutes
    - Both tokens are single-use (acceptedAt/usedAt marked on use)
    - Email sending falls back to console.log when RESEND_API_KEY not set
    - Login page links to magic link page and vice versa
  </done>
</task>

<task type="auto">
  <name>Task 2: Build role-specific dashboards, user management, and loading skeletons</name>
  <files>
    src/app/(dashboard)/page.tsx
    src/app/(dashboard)/admin/page.tsx
    src/app/(dashboard)/investor/page.tsx
    src/app/(dashboard)/investor/layout.tsx
    src/app/(dashboard)/settings/users/page.tsx
    src/app/(dashboard)/settings/layout.tsx
    src/components/dashboard/DashboardSkeleton.tsx
    src/components/dashboard/KPICard.tsx
    src/components/dashboard/RoleBadge.tsx
  </files>
  <action>
    1. Create `src/components/dashboard/DashboardSkeleton.tsx` -- Loading skeleton (INFRA-11):
       - Use react-loading-skeleton library
       - `DashboardSkeleton` component: renders a grid of 6 skeleton cards
       - Each card: skeleton title line (width 120px, height 24px) + skeleton value line (width 80px, height 40px)
       - Grid: 1 col on mobile, 2 on md, 3 on lg
       - Supports dark mode (containerClassName for dark bg)
       - Export as named export

    2. Create `src/components/dashboard/KPICard.tsx` -- KPI card component:
       - Props: title (string), value (string | number), subtitle (string, optional), icon (ReactNode, optional), trend (string, optional -- "up"/"down"/"neutral"), color (string, optional -- defaults to caribbean-green)
       - Card with shadow, rounded corners, padding
       - Icon in top-right corner with faded color
       - Title in muted text, value in large bold text, subtitle in small muted text
       - If trend: small colored arrow indicator (green up, red down)
       - Caribbean styling: left border accent in caribbean-green or specified color
       - Mobile-first: full-width, compact padding on mobile

    3. Create `src/components/dashboard/RoleBadge.tsx` -- Role badge component:
       - Props: role (string)
       - Color-coded badge:
         - ADMIN: caribbean-green bg
         - MANAGER: blue bg
         - SALES_REP: caribbean-gold bg
         - INVESTOR: purple bg
       - Uppercase text, small rounded pill shape

    4. Update `src/app/(dashboard)/page.tsx` -- Main dashboard (AUTH-05):
       - Server Component, calls getUser() from DAL
       - Role-based content routing:
         - ADMIN and MANAGER: Show overview with placeholder KPI cards
         - SALES_REP: Show sales-focused placeholder cards
         - INVESTOR: Redirect to /dashboard/investor
       - Welcome section: "Welcome back, {name}" with RoleBadge
       - Admin/Manager view -- 6 KPI cards (placeholders with realistic labels):
         - Today's Revenue ($0 -- coming in Phase 6)
         - MTD Revenue ($0 -- coming in Phase 6)
         - Units Produced (0 -- coming in Phase 2)
         - Current Inventory (0 -- coming in Phase 3)
         - Open Orders (0 -- coming in Phase 4)
         - Accounts Receivable ($0 -- coming in Phase 4)
       - Sales Rep view -- 4 KPI cards:
         - My Orders Today (0), My Revenue MTD ($0), Active Customers (0), Pending Follow-ups (0)
       - Wrap KPI cards in Suspense with DashboardSkeleton fallback
       - Quick action buttons section with DISABLED state and tooltips:
         - Admin: "New Batch", "New Order", "Record Expense", "Transfer Inventory"
         - Manager: "New Batch", "New Order", "Transfer Inventory"
         - Sales: "New Order", "New Customer"
       - Each button: shadcn Button variant "outline", Caribbean gold border, `disabled={true}`, wrapped in a tooltip (use shadcn Tooltip or title attribute) that says "Coming soon in Phase {N}" where N is the relevant phase number (e.g., "Coming soon in Phase 2" for New Batch, "Coming soon in Phase 4" for New Order)
       - Mobile: 2-column grid for action buttons, single column for KPIs

    5. Create `src/app/(dashboard)/investor/layout.tsx` -- Investor layout:
       - Server Component, calls verifySession() from DAL
       - If role is not ADMIN and not INVESTOR: redirect to /dashboard (unauthorized)
       - Render children (investor pages use dashboard layout but with restricted access)

    6. Create `src/app/(dashboard)/investor/page.tsx` -- Investor dashboard (AUTH-05 for Investor):
       - Server Component, calls getUser()
       - READ-ONLY view -- no action buttons, no edit capabilities
       - Welcome: "Investor Dashboard" heading
       - Placeholder sections with KPI cards:
         - Revenue Overview: MTD Revenue ($0), YTD Revenue ($0), Revenue Growth (0%)
         - Production Metrics: Units Produced MTD (0), Production Capacity (0%)
         - Market Traction: Active Customers (0), Channel Count (0)
         - Financial Health: Gross Margin (0%), Net Margin (0%)
       - Ownership section: Card showing equity structure (from PROJECT.md):
         - Anthony Amos Jr. -- CEO/Founder -- 70%
         - Olatunde Ogunjulugbe -- President -- 30%
       - All values are placeholder (real data comes in later phases)
       - Mobile-first responsive grid

    7. Create `src/app/(dashboard)/settings/layout.tsx` -- Settings layout:
       - Server Component, calls verifyAdmin() -- only admins access settings
       - Simple wrapper that verifies admin access

    8. Create `src/app/(dashboard)/settings/users/page.tsx` -- User management (AUTH-03 UI):
       - Server Component, calls verifyAdmin()
       - Two sections:
         a) **Current Users** -- table/list showing all users:
            - Fetch all users from db.user.findMany (select id, name, email, role, isActive, createdAt)
            - Show in responsive table: Name, Email, Role (with RoleBadge), Status (Active/Inactive), Joined date
            - Mobile: card layout instead of table
         b) **Invite New User** -- form:
            - 'use client' sub-component for the invite form
            - Email input, Role select (dropdown with MANAGER, SALES_REP, INVESTOR -- cannot invite ADMIN)
            - Submit button: "Send Invite"
            - Use useActionState with sendInvite action
            - Success: toast.success("Invite sent!")
            - Error: toast.error with error message
         c) **Pending Invites** -- list of sent invites not yet accepted:
            - Fetch InviteTokens where acceptedAt is null and expiresAt > now
            - Show: Email, Role, Sent date, Expires date
            - Mobile-friendly card layout
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build succeeds. Then install shadcn tooltip if not already added:
    ```bash
    npx shadcn@latest add tooltip
    ```
    Then test the full flow:
    1. Log in as Anthony (ADMIN) -- see admin dashboard with 6 KPI cards and quick actions (all disabled with tooltips)
    2. Hover over "New Batch" button -- tooltip shows "Coming soon in Phase 2"
    3. Hover over "New Order" button -- tooltip shows "Coming soon in Phase 4"
    4. Navigate to Settings > Users -- see user list and invite form
    5. Send invite to test@test.com as SALES_REP -- toast success
    6. Log out, accept invite at /invite/{token} -- create account
    7. Log in as new SALES_REP -- see sales-focused dashboard (4 KPI cards, no production/inventory)
    8. Verify SALES_REP quick actions are also disabled with tooltips
    9. Log in as Anthony again, visit /dashboard/investor -- see investor dashboard with equity info
    10. Verify SALES_REP cannot access /dashboard/investor (redirect to /dashboard)
    11. Verify SALES_REP cannot access /settings (redirect or error)
    12. Check that loading skeletons appear briefly before KPI cards render
    13. Test on mobile viewport -- cards stack, sidebar is overlay
  </verify>
  <done>
    - Admin sees all KPI cards (6) + all quick action buttons (disabled with "Coming soon in Phase N" tooltips) + full sidebar navigation
    - Manager sees operations KPI cards (6) + limited quick actions (disabled with tooltips)
    - Sales Rep sees sales-focused KPI cards (4) + sales quick actions (disabled with tooltips)
    - Investor sees read-only dashboard with revenue, production, market, financial placeholders + equity structure
    - Quick action buttons are explicitly disabled with tooltip explaining which phase will enable them
    - Investor dashboard blocks non-admin/non-investor users
    - Settings restricted to admin only
    - User management page shows current users, invite form, pending invites
    - Invite form sends invite via Server Action with role pre-assignment
    - Loading skeletons display while data loads (Suspense boundaries)
    - KPICard component renders with Caribbean styling and optional trend indicator
    - RoleBadge shows color-coded role indicator
    - All views are mobile-first responsive
  </done>
</task>

</tasks>

<verification>
1. Admin (Anthony) logs in -> sees admin dashboard with all 6 KPI cards and all sidebar navigation
2. Quick action buttons are disabled with tooltips showing relevant phase numbers
3. Admin navigates to Settings > Users -> sees user list, invite form, pending invites
4. Admin sends invite to new email -> invite token created, email sent (or logged)
5. New user accepts invite at /invite/{token} -> sets password, account created, redirected to dashboard
6. New Sales Rep logs in -> sees only sales-focused dashboard (4 KPIs, limited sidebar)
7. Sales Rep cannot access /settings or /dashboard/investor (blocked by role check)
8. Admin views /dashboard/investor -> sees investor dashboard with equity structure
9. User requests magic link -> token created -> email sent -> click link -> session created -> redirected to correct dashboard
10. Used magic link cannot be reused (redirects to /login with error)
11. Expired invite (>7 days) shows error message
12. Loading skeletons appear in dashboard before KPI cards render
13. All pages work on mobile viewport (responsive)
</verification>

<success_criteria>
1. Invite system works end-to-end: admin sends invite -> user accepts -> account created with correct role
2. Magic link auth works end-to-end with explicit verification: request link -> receive email -> click link -> session created -> user logged in and redirected to correct dashboard
3. Magic link tokens are single-use and expire after 15 minutes
4. All 4 roles see appropriate dashboard content (Admin, Manager, Sales Rep, Investor)
5. Access control enforced: each role can only see permitted sections
6. Quick action buttons are disabled with tooltips indicating future phase availability
7. User management page (admin-only) shows users, invites, and invite form
8. Loading skeletons display during data loading transitions
9. All views are mobile-first responsive
10. Token expiration enforced (7 days invite, 15 min magic link)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>
