---
phase: 03-inventory-management
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/actions/packaging.ts
  - src/app/(dashboard)/dashboard/inventory/packaging/page.tsx
  - src/components/inventory/PackagingMaterialForm.tsx
  - src/components/inventory/PackagingMaterialList.tsx
  - src/components/inventory/ReorderAlertPanel.tsx
  - src/app/(dashboard)/dashboard/inventory/valuation/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view packaging materials with current quantities and expiration/reorder status"
    - "User can add and update packaging materials with supplier, quantity, reorder point, and lead time"
    - "System shows 30-day supply alerts for packaging materials approaching reorder point"
    - "Raw materials display reorder alerts based on 2-week and 4-week lead times"
    - "User can view inventory valuation report showing FIFO cost values per product per location"
  artifacts:
    - path: "src/app/actions/packaging.ts"
      provides: "Server actions for packaging material CRUD, reorder alerts, and valuation report"
      exports: ["getPackagingMaterials", "createPackagingMaterial", "updatePackagingMaterial", "getReorderAlerts", "getInventoryValuation"]
    - path: "src/app/(dashboard)/dashboard/inventory/packaging/page.tsx"
      provides: "Packaging materials page with form, list, and reorder alerts"
      min_lines: 20
    - path: "src/components/inventory/PackagingMaterialForm.tsx"
      provides: "Form for adding/editing packaging materials"
      min_lines: 40
    - path: "src/components/inventory/PackagingMaterialList.tsx"
      provides: "List of packaging materials with stock status badges"
      min_lines: 40
    - path: "src/components/inventory/ReorderAlertPanel.tsx"
      provides: "Alert panel showing materials and packaging below reorder point"
      min_lines: 30
    - path: "src/app/(dashboard)/dashboard/inventory/valuation/page.tsx"
      provides: "FIFO-based inventory valuation report page"
      min_lines: 30
  key_links:
    - from: "src/components/inventory/PackagingMaterialForm.tsx"
      to: "src/app/actions/packaging.ts"
      via: "useActionState with createPackagingMaterial"
      pattern: "useActionState.*createPackagingMaterial"
    - from: "src/components/inventory/ReorderAlertPanel.tsx"
      to: "src/app/actions/packaging.ts"
      via: "Receives reorder alert data from server component"
      pattern: "getReorderAlerts"
    - from: "src/app/(dashboard)/dashboard/inventory/valuation/page.tsx"
      to: "src/app/actions/packaging.ts"
      via: "Calls getInventoryValuation for FIFO cost report"
      pattern: "getInventoryValuation"
---

<objective>
Build packaging materials tracking, reorder alert system, and FIFO inventory valuation report.

Purpose: This plan covers the supply-chain monitoring side of inventory — tracking packaging materials (bottles, caps, labels) with supply alerts, raw materials reorder warnings, and a financial valuation report using FIFO cost method. These features help Anthony and Tunde avoid production delays from material shortages and provide financial visibility for investor conversations.

Output: Packaging materials CRUD page, ReorderAlertPanel component with combined raw materials + packaging alerts, and inventory valuation report page.
</objective>

<execution_context>
@/Users/rfmstaff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rfmstaff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-inventory-management/03-RESEARCH.md
@.planning/phases/03-inventory-management/03-01-SUMMARY.md

Key existing patterns:
- Raw materials CRUD: src/app/actions/raw-materials.ts, src/components/production/RawMaterialForm.tsx, RawMaterialList.tsx — follow this pattern closely for packaging materials
- Badge component: src/components/ui/badge.tsx with success/warning/destructive variants
- Expiration logic: differenceInDays from date-fns (already used in RawMaterialList)
- Form pattern: useActionState with server actions, Zod validation

Files from Plan 01 this depends on:
- prisma/schema.prisma (PackagingMaterial model with reorderPoint, leadTimeDays, currentQuantity)
- src/lib/validators/inventory.ts (packagingMaterialSchema)
- src/lib/utils/reorder-point.ts (calculateReorderPoint, classifyStockLevel)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packaging server actions and packaging materials CRUD page</name>
  <files>src/app/actions/packaging.ts, src/app/(dashboard)/dashboard/inventory/packaging/page.tsx, src/components/inventory/PackagingMaterialForm.tsx, src/components/inventory/PackagingMaterialList.tsx</files>
  <action>
**src/app/actions/packaging.ts:**

'use server' directive. Follow pattern from src/app/actions/raw-materials.ts.

1. `getPackagingMaterials()` — Fetch all active packaging materials, ordered by type then name. No auth requirement (read-only).

2. `createPackagingMaterial(prevState, formData)` — Create a new packaging material.
   - verifyManagerOrAbove()
   - Validate with packagingMaterialSchema from validators/inventory.ts
   - Check for duplicate name (case-sensitive, matching SQLite pattern from Phase 2)
   - Create record in db.packagingMaterial
   - revalidatePath('/dashboard/inventory/packaging')
   - Return form state

3. `updatePackagingMaterial(id, prevState, formData)` — Update existing material.
   - verifyManagerOrAbove()
   - Validate with packagingMaterialSchema
   - Update record, check name uniqueness excluding current record
   - revalidatePath('/dashboard/inventory/packaging')

4. `deactivatePackagingMaterial(id)` — Soft delete.
   - verifyAdmin()
   - Set isActive = false
   - revalidatePath('/dashboard/inventory/packaging')

5. `getReorderAlerts()` — Returns materials needing reorder attention.
   - Fetch active PackagingMaterials where currentQuantity <= reorderPoint
   - Fetch active RawMaterials and check if their quantity (converted to comparable unit) is low — since RawMaterial doesn't have explicit reorderPoint, use the 30-day alert logic: if expirationDate is within 30 days, flag it
   - Also check if any RawMaterial quantity is running low based on recent batch usage patterns (if available) — for simplicity in this phase, flag raw materials expiring within 2 weeks (urgent) and 4 weeks (warning)
   - Return two arrays: { packagingAlerts: [...], rawMaterialAlerts: [...] }
   - Each alert has: name, type, currentQuantity, reorderPoint, level ('CRITICAL' or 'WARNING'), daysOfSupply (estimated)

6. `getInventoryValuation()` — FIFO cost-based inventory valuation.
   - For each product at each location, compute stock using the same logic as getStockLevels
   - For valuation: since individual batch cost isn't tracked yet (no costPerUnit on Batch), use a placeholder approach:
     - Get product's pricing tiers, use wholesale cash price as proxy for COGS (or use a fixed cost ratio if available)
     - Multiply available quantity * estimated unit cost
   - Return: Array of { product, location, quantity, unitCost, totalValue }
   - Also return grand total value across all products/locations
   - NOTE: This is an approximation. Full COGS tracking (materials + labor + overhead per batch) comes in Phase 6 (Financial Management). Add a note in the UI: "Estimated values based on wholesale pricing. Detailed COGS available in Financial Reports."

**src/components/inventory/PackagingMaterialForm.tsx:**

'use client' component. Follow RawMaterialForm.tsx pattern closely.

Form fields:
1. Name (text input) — e.g., "5oz Glass Bottle"
2. Type (select) — BOTTLE, CAP, LABEL, BOX, OTHER
3. Supplier (text input)
4. Current Quantity (number input, inputMode="numeric")
5. Unit (select) — units, rolls, sheets, cases
6. Reorder Point (number input) — threshold for alerts
7. Lead Time Days (number input) — supplier delivery time
8. Cost Per Unit (number input, optional) — for valuation

Submit: "Add Material" / "Adding..."

Support edit mode: if `editingMaterial` prop is passed, pre-fill form and show "Update" button.

Props: `{ editingMaterial?: PackagingMaterial, onCancel?: () => void }`

**src/components/inventory/PackagingMaterialList.tsx:**

'use client' component. Follow RawMaterialList.tsx pattern.

Table/card layout showing:
- Name
- Type (with badge)
- Supplier
- Current Quantity / Reorder Point (e.g., "450 / 500" — red if below reorder)
- Lead Time (e.g., "14 days")
- Cost Per Unit
- Status badge: use classifyStockLevel from reorder-point.ts comparing currentQuantity vs reorderPoint
- Edit button, Deactivate button (admin only)

Desktop: table rows. Mobile: cards.

Props: `{ materials: PackagingMaterial[], isAdmin: boolean }`

**src/app/(dashboard)/dashboard/inventory/packaging/page.tsx:**

Server Component:
1. verifyManagerOrAbove()
2. Fetch packaging materials via getPackagingMaterials()
3. Get session to determine isAdmin
4. Render page header: "Packaging Materials" with breadcrumb to /dashboard/inventory
5. Render PackagingMaterialForm (add mode)
6. Render PackagingMaterialList with materials and isAdmin props
  </action>
  <verify>
1. `npx tsc --noEmit` — compiles
2. /dashboard/inventory/packaging renders form and list
3. Packaging materials seeded from Plan 01 appear in the list with stock status badges
4. Form submission creates new material
  </verify>
  <done>
Packaging materials page at /dashboard/inventory/packaging shows CRUD form and list with stock status badges. Server actions handle create/update/deactivate with validation. List shows current quantity vs reorder point with green/yellow/red status. Mobile responsive with card layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ReorderAlertPanel and inventory valuation report page</name>
  <files>src/components/inventory/ReorderAlertPanel.tsx, src/app/(dashboard)/dashboard/inventory/valuation/page.tsx</files>
  <action>
**src/components/inventory/ReorderAlertPanel.tsx:**

Server-rendered component (no 'use client' needed — just receives data as props).

Displays two sections:

1. **Packaging Material Alerts** — Items below reorder point
   - Each alert card shows: material name, type, current quantity, reorder point, lead time, estimated days of supply
   - Red background for CRITICAL (below reorder), yellow for WARNING (within 20% of reorder)
   - If no alerts: green "All packaging materials adequately stocked" message

2. **Raw Material Alerts** — Items expiring or running low
   - Each alert card shows: material name, supplier, lot number, expiration date, days until expiration
   - Red for expiring within 14 days (2-week lead time), yellow for expiring within 28 days (4-week lead time)
   - If no alerts: green "All raw materials within acceptable range" message

Layout: Two-column grid on desktop (packaging left, raw materials right), stacked on mobile.

Props:
```typescript
{
  packagingAlerts: Array<{
    id: string;
    name: string;
    type: string;
    currentQuantity: number;
    reorderPoint: number;
    leadTimeDays: number;
    level: 'CRITICAL' | 'WARNING';
  }>;
  rawMaterialAlerts: Array<{
    id: string;
    name: string;
    supplier: string;
    lotNumber: string;
    expirationDate: Date;
    daysUntilExpiration: number;
    level: 'CRITICAL' | 'WARNING';
  }>;
}
```

This component will be placed on the main inventory dashboard page (page.tsx from Plan 02) as well as the packaging page. Since Plan 02 runs in parallel, the executor for Plan 02 should check if this component exists and include it. If not, it can be added in a later integration step during verification.

**src/app/(dashboard)/dashboard/inventory/valuation/page.tsx:**

Server Component for INV-11 (inventory valuation using FIFO cost method):

1. verifyManagerOrAbove()
2. Call getInventoryValuation() from packaging.ts
3. Render page header: "Inventory Valuation Report" with breadcrumb to /dashboard/inventory
4. Show summary cards at top:
   - Total Inventory Value (sum of all product/location values)
   - Total Units (sum of all quantities)
   - Number of Products with stock
   - Number of Locations with stock

5. Render valuation table:
   - Columns: Product (name + SKU), Location, Units, Est. Unit Cost, Est. Total Value
   - Group by product with subtotals per product
   - Grand total row at bottom
   - Desktop: full table. Mobile: cards grouped by product.

6. Add disclaimer note at bottom:
   "Note: Values shown are estimates based on wholesale pricing. Detailed cost of goods sold (COGS) tracking including materials, labor, and overhead will be available in Phase 6: Financial Management."

7. Optional: Add a "Print / Export" button placeholder (disabled with tooltip "Export coming in Phase 7"). This follows the existing pattern of disabled buttons with phase tooltips from Phase 1.
  </action>
  <verify>
1. `npx tsc --noEmit` — compiles
2. /dashboard/inventory/valuation renders with valuation data (or empty state if no stock)
3. ReorderAlertPanel renders packaging and raw material alerts correctly
4. Valuation table shows per-product per-location breakdown with totals
  </verify>
  <done>
ReorderAlertPanel shows combined packaging and raw material alerts with red/yellow severity levels. Valuation report page at /dashboard/inventory/valuation shows FIFO-based inventory values per product per location with summary cards and grand total. Both are mobile-responsive.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /dashboard/inventory/packaging renders packaging material CRUD with stock status badges
3. /dashboard/inventory/valuation renders valuation report with product/location breakdown
4. ReorderAlertPanel shows alerts for low packaging materials and expiring raw materials
5. Packaging form creates/updates materials via server actions
6. Valuation report shows estimated unit cost and total value per product per location
7. All pages mobile-responsive with card layouts
</verification>

<success_criteria>
- INV-07: Packaging materials tracked with reorder point and lead time, 30-day supply alerts visible
- INV-08: Raw materials show reorder alerts for 2-week (critical) and 4-week (warning) lead times
- INV-11: Inventory valuation report shows FIFO cost values per product per location with totals
- Packaging materials CRUD works with server actions and Zod validation
- Alerts display in combined ReorderAlertPanel with severity levels
- All pages have breadcrumb navigation back to inventory dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/03-inventory-management/03-04-SUMMARY.md`
</output>
